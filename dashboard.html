<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»è¯è¨˜éŒ„ç°¿ç³»çµ± - ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #4facfe;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .action-button.primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .action-button.secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1em;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 20px;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š é›»è¯è¨˜éŒ„ç°¿ç³»çµ±</h1>
            <p>ä¸­å¸«è‹±æ–‡ç§‘ç®¡ç†é¢æ¿</p>
        </div>
        
        <div class="main-content">
            <!-- ç³»çµ±çµ±è¨ˆ -->
            <div class="section">
                <h2>ğŸ“Š ç³»çµ±æ¦‚æ³</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="teacherCount">0</div>
                        <div class="stat-label">è‹±æ–‡è€å¸«</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="studentCount">0</div>
                        <div class="stat-label">å­¸ç”Ÿç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="contactCount">0</div>
                        <div class="stat-label">é›»è¯è¨˜éŒ„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="semesterProgress">0%</div>
                        <div class="stat-label" id="semesterProgressLabel">å­¸æœŸé€²åº¦</div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»è¦åŠŸèƒ½ -->
            <div class="section">
                <h2>ğŸš€ ä¸»è¦åŠŸèƒ½</h2>
                <div class="button-grid">
                    <button class="action-button primary" onclick="showMasterListModal()">
                        ğŸ“‹ å¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿
                    </button>
                    <button class="action-button" onclick="initializeSystem()">
                        ğŸ—ï¸ åˆå§‹åŒ–ç³»çµ±
                    </button>
                    <button class="action-button" onclick="showTeacherModal()">
                        ğŸ‘¨â€ğŸ« æ–°å¢å–®ä¸€è€å¸«è¨˜éŒ„ç°¿
                    </button>
                    <button class="action-button secondary" onclick="openSystemFolder()">
                        ğŸ“ é–‹å•Ÿç³»çµ±è³‡æ–™å¤¾
                    </button>
                </div>
            </div>
            
            <!-- è³‡æ–™ç®¡ç† -->
            <div class="section">
                <h2>ğŸ“ è³‡æ–™ç®¡ç†</h2>
                <div class="button-grid">
                    <button class="action-button" onclick="importStudentData()">
                        ğŸ“¥ åŒ¯å…¥å­¸ç”Ÿè³‡æ–™
                    </button>
                    <button class="action-button" onclick="exportStudentData()">
                        ğŸ“¤ åŒ¯å‡ºå­¸ç”Ÿè³‡æ–™
                    </button>
                    <button class="action-button" onclick="updateTeachersList()">
                        ğŸ”„ æ›´æ–°è€å¸«åˆ—è¡¨
                    </button>
                    <button class="action-button secondary" onclick="checkAllProgress()">
                        ğŸ“Š æª¢æŸ¥å…¨é«”é€²åº¦
                    </button>
                    <button class="action-button secondary" onclick="generateProgressReport()">
                        ğŸ“ˆ ç”Ÿæˆé€²åº¦å ±å‘Š
                    </button>
                </div>
            </div>
            
            <!-- ç³»çµ±ç®¡ç† -->
            <div class="section">
                <h2>âš™ï¸ ç³»çµ±ç®¡ç†</h2>
                <div class="button-grid">
                    <button class="action-button" onclick="setupAutomation()">
                        ğŸ”„ è¨­å®šè‡ªå‹•åŒ–
                    </button>
                    <button class="action-button" onclick="performBackup()">
                        ğŸ’¾ æ‰‹å‹•å‚™ä»½
                    </button>
                    <button class="action-button secondary" onclick="checkFileIntegrity()">
                        ğŸ” æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§
                    </button>
                    <button class="action-button secondary" onclick="showSystemSettings()">
                        âš™ï¸ ç³»çµ±è¨­å®š
                    </button>
                </div>
            </div>
            
            <!-- ç³»çµ±ç›£æ§ -->
            <div class="section">
                <h2>ğŸ“Š ç³»çµ±ç›£æ§</h2>
                
                <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤º -->
                <div id="systemStatusIndicator" style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h3 style="color: #495057; margin-bottom: 10px;">ğŸ”„ æª¢æŸ¥ç³»çµ±ç‹€æ…‹ä¸­...</h3>
                        <p style="color: #6c757d; margin: 0;">æ­£åœ¨æª¢æŸ¥ç³»çµ±åˆå§‹åŒ–ç‹€æ…‹ï¼Œè«‹ç¨å€™...</p>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿè¨­å®šå€ - å‹•æ…‹ç”Ÿæˆ -->
                <div id="quickSetupSection" style="display: none; margin-bottom: 20px;">
                    <!-- å…§å®¹ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <!-- ç³»çµ±ç›£æ§å·¥å…· -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #495057; margin-bottom: 10px;">ğŸ”§ ç›£æ§å·¥å…·</h3>
                    <div class="button-grid">
                        <button class="action-button secondary" onclick="checkSystemStatus()">
                            ğŸ“Š æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                        </button>
                        <button class="action-button secondary" onclick="executeSystemTest()">
                            ğŸ§ª åŸ·è¡Œç³»çµ±æ¸¬è©¦
                        </button>
                    </div>
                </div>
                
                <div class="instructions" style="margin-top: 20px;">
                    <h3>ğŸ“š ä½¿ç”¨èªªæ˜ï¼š</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6;">
                        <p><strong>ğŸ”§ ç›£æ§å·¥å…·ï¼š</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>æª¢æŸ¥ç³»çµ±ç‹€æ…‹ï¼š</strong>é©—è­‰ç³»çµ±åˆå§‹åŒ–ç‹€æ…‹å’Œå¥åº·åº¦</li>
                            <li><strong>åŸ·è¡Œç³»çµ±æ¸¬è©¦ï¼š</strong>æ¸¬è©¦æ ¸å¿ƒåŠŸèƒ½ï¼šé€²åº¦æª¢æŸ¥ã€å ±å‘Šç”Ÿæˆã€å‚™ä»½ã€æª”æ¡ˆå®Œæ•´æ€§</li>
                        </ul>
                        <p style="color: #666; font-style: italic; margin-top: 10px;">
                            ğŸ’¡ å»ºè­°ï¼šé¦–æ¬¡ä½¿ç”¨æˆ–ç³»çµ±æ›´æ–°å¾ŒåŸ·è¡Œç³»çµ±æ¸¬è©¦é©—è­‰åŠŸèƒ½æ­£å¸¸ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="section">
                <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
                <div class="instructions">
                    <h3>å¿«é€Ÿé–‹å§‹æŒ‡å—ï¼š</h3>
                    <ol>
                        <li><strong>ç³»çµ±åˆå§‹åŒ–ï¼š</strong>é¦–æ¬¡ä½¿ç”¨è«‹é»æ“Šã€Œåˆå§‹åŒ–ç³»çµ±ã€å»ºç«‹åŸºæœ¬è³‡æ–™å¤¾çµæ§‹</li>
                        <li><strong>æ‰¹é‡å»ºç«‹ï¼š</strong>æº–å‚™å­¸ç”Ÿç¸½è¡¨ï¼ˆåŒ…å« LT æ¬„ä½ï¼‰ï¼Œä½¿ç”¨ã€Œå¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿ã€åŠŸèƒ½</li>
                        <li><strong>è³‡æ–™åŒ¯å…¥ï¼š</strong>ç³»çµ±æœƒè‡ªå‹•å¾å­¸ç”Ÿç¸½è¡¨æå–å„è€å¸«å°æ‡‰çš„å­¸ç”Ÿè³‡æ–™</li>
                        <li><strong>æ—¥å¸¸ä½¿ç”¨ï¼š</strong>è€å¸«å€‘å¯ç›´æ¥åœ¨å„è‡ªçš„è¨˜éŒ„ç°¿ä¸­é€²è¡Œé›»è¯è¨˜éŒ„</li>
                        <li><strong>é€²åº¦è¿½è¹¤ï¼š</strong>ä½¿ç”¨ã€Œæª¢æŸ¥å…¨é«”é€²åº¦ã€ç›£æ§æ•´é«”é›»è¯æƒ…æ³</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2024 é›»è¯è¨˜éŒ„ç°¿ç³»çµ± - å°ˆç‚ºä¸­å¸«è‹±æ–‡ç§‘è¨­è¨ˆ</p>
        </div>
    </div>

    <!-- å­¸ç”Ÿç¸½è¡¨åŒ¯å…¥æ¨¡æ…‹æ¡† -->
    <div id="masterListModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ğŸ“‹ å¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿</h2>
            
            <!-- é¸é …é¸æ“‡ -->
            <div class="form-group">
                <label>è«‹é¸æ“‡å­¸ç”Ÿç¸½è¡¨ä¾†æºï¼š</label>
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="radio" name="masterListSource" value="system" checked style="margin-right: 8px;">
                        ğŸ”¥ ä½¿ç”¨ç³»çµ±å­¸ç”Ÿç¸½è¡¨ï¼ˆæ¨è–¦ï¼‰
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        ä½¿ç”¨åˆå§‹åŒ–æ™‚å‰µå»ºçš„å­¸ç”Ÿç¸½è¡¨ï¼Œç„¡éœ€è¼¸å…¥ ID
                    </small>
                    
                    <label style="display: block; margin-top: 12px;">
                        <input type="radio" name="masterListSource" value="custom" style="margin-right: 8px;">
                        ğŸ“‹ ä½¿ç”¨è‡ªè¨‚å­¸ç”Ÿç¸½è¡¨
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        ä½¿ç”¨å…¶ä»– Google Sheets æª”æ¡ˆä½œç‚ºå­¸ç”Ÿç¸½è¡¨
                    </small>
                </div>
            </div>
            
            <!-- è‡ªè¨‚ ID è¼¸å…¥å€åŸŸ -->
            <div id="customIdSection" class="form-group" style="display: none;">
                <label for="masterListId">å­¸ç”Ÿç¸½è¡¨ Google Sheets IDï¼š</label>
                <input type="text" id="masterListId" placeholder="è«‹è¼¸å…¥ Google Sheets çš„å®Œæ•´ ID">
                <small style="color: #666; display: block; margin-top: 5px;">
                    ç¯„ä¾‹ï¼šå¾ https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit ä¸­è¤‡è£½ 1ABC...XYZ éƒ¨åˆ†
                </small>
            </div>
            
            <div class="form-group">
                <label>ç³»çµ±è¦æ±‚ï¼š</label>
                <ul style="padding-left: 20px; color: #666;">
                    <li>å­¸ç”Ÿç¸½è¡¨å¿…é ˆåŒ…å« LT (Local Teacher) æ¬„ä½</li>
                    <li>åŒ…å« English Class æ¬„ä½ç”¨æ–¼ç­ç´šè³‡è¨Š</li>
                    <li>åŒ…å«å­¸ç”ŸåŸºæœ¬è³‡æ–™æ¬„ä½</li>
                </ul>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="processMasterList()" style="margin-right: 10px;">
                    é–‹å§‹è™•ç†
                </button>
                <button class="action-button secondary" onclick="closeMasterListModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è€å¸«æ¨¡æ…‹æ¡† -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ğŸ‘¨â€ğŸ« æ–°å¢è€å¸«è¨˜éŒ„ç°¿</h2>
            <div class="form-group">
                <label for="teacherName">è€å¸«å§“åï¼š</label>
                <input type="text" id="teacherName" placeholder="è«‹è¼¸å…¥è€å¸«å§“å">
            </div>
            <div class="form-group">
                <label for="teacherClasses">æˆèª²ç­ç´šï¼š</label>
                <input type="text" id="teacherClasses" placeholder="ä¾‹å¦‚ï¼š701,702,703ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="createSingleTeacher()" style="margin-right: 10px;">
                    å»ºç«‹è¨˜éŒ„ç°¿
                </button>
                <button class="action-button secondary" onclick="closeTeacherModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>


    <script>
        // Google Apps Script éƒ¨ç½²é…ç½®
        const SYSTEM_CONFIG = {
            // MAIN_FOLDER_ID å°‡å¾å¾Œç«¯å‹•æ…‹ç²å–ï¼Œä¸éœ€è¦ç¡¬ç·¨ç¢¼
            // ç›´æ¥ä½¿ç”¨ google.script.run èª¿ç”¨å¾Œç«¯å‡½æ•¸
        };

        // æ¨¡æ…‹æ¡†æ§åˆ¶
        function showMasterListModal() {
            document.getElementById('masterListModal').style.display = 'block';
        }

        function closeMasterListModal() {
            document.getElementById('masterListModal').style.display = 'none';
        }

        function showTeacherModal() {
            document.getElementById('teacherModal').style.display = 'block';
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').style.display = 'none';
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // é—œé–‰æŒ‰éˆ•äº‹ä»¶
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                this.closest('.modal').style.display = 'none';
            }
        });

        // è™•ç†å­¸ç”Ÿç¸½è¡¨ä¾†æºé¸æ“‡
        document.addEventListener('change', function(e) {
            if (e.target.name === 'masterListSource') {
                const customSection = document.getElementById('customIdSection');
                if (e.target.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            }
        });

        // ä¸»è¦åŠŸèƒ½å‡½æ•¸
        function processMasterList() {
            const sourceType = document.querySelector('input[name="masterListSource"]:checked').value;
            let sheetId = '';
            
            if (sourceType === 'custom') {
                sheetId = document.getElementById('masterListId').value.trim();
                if (!sheetId) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿç¸½è¡¨çš„ Google Sheets ID');
                    return;
                }
            }
            // å¦‚æœæ˜¯ systemï¼ŒsheetId ä¿æŒç©ºå­—ä¸²ï¼Œå¾Œç«¯æœƒè‡ªå‹•ä½¿ç”¨ç³»çµ±å­¸ç”Ÿç¸½è¡¨
            
            // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è™•ç†ä¸­...';
            button.disabled = true;
            
            // èª¿ç”¨å®Œæ•´çš„ Web ç‰ˆæœ¬åŠŸèƒ½
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeMasterListModal();
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                        if (result.results && result.results.successCount > 0) {
                            updateStats(); // æ›´æ–°çµ±è¨ˆè³‡æ–™
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .createTeachersFromStudentMasterListWeb(sheetId);
        }

        function createSingleTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const classes = document.getElementById('teacherClasses').value.trim();
            
            if (!name || !classes) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„è€å¸«è³‡è¨Š');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'å»ºç«‹ä¸­...';
            button.disabled = true;
            
            // æº–å‚™è³‡æ–™
            const formData = {
                action: 'createSingleTeacher',
                teacherName: name,
                teacherClasses: classes
            };
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeTeacherModal();
                    if (result.success) {
                        alert('è€å¸«è¨˜éŒ„ç°¿å»ºç«‹æˆåŠŸï¼\n' + result.message);
                        if (result.recordBookUrl) {
                            if (confirm('æ˜¯å¦è¦é–‹å•Ÿæ–°å»ºç«‹çš„è¨˜éŒ„ç°¿ï¼Ÿ')) {
                                window.open(result.recordBookUrl, '_blank');
                            }
                        }
                    } else {
                        alert('å»ºç«‹å¤±æ•—ï¼š' + result.message);
                    }
                    updateStats();
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('å»ºç«‹å¤±æ•—ï¼š' + error.message);
                })
                .createSingleTeacherWeb(formData);
        }

        function initializeSystem() {
            if (confirm('ç¢ºå®šè¦åˆå§‹åŒ–ç³»çµ±å—ï¼Ÿé€™å°‡å»ºç«‹å¿…è¦çš„è³‡æ–™å¤¾çµæ§‹ã€‚')) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            alert('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼\n' + result.message);
                            
                            // æä¾›å¤šå€‹é¸é …è®“ä½¿ç”¨è€…é¸æ“‡è¦é–‹å•Ÿçš„æª”æ¡ˆ
                            const options = [];
                            if (result.mainFolderUrl) options.push('ç³»çµ±ä¸»è³‡æ–™å¤¾');
                            if (result.masterListUrl) options.push('å­¸ç”Ÿç¸½è¡¨');
                            if (result.adminSheetUrl) options.push('ç®¡ç†æ§åˆ¶å°');
                            
                            if (options.length > 0) {
                                const choice = prompt('é¸æ“‡è¦é–‹å•Ÿçš„æª”æ¡ˆï¼š\n1. ç³»çµ±ä¸»è³‡æ–™å¤¾\n2. å­¸ç”Ÿç¸½è¡¨ï¼ˆå»ºè­°å…ˆé–‹å•Ÿé€™å€‹ï¼‰\n3. ç®¡ç†æ§åˆ¶å°\n\nè«‹è¼¸å…¥æ•¸å­— (1-3)ï¼š');
                                
                                switch(choice) {
                                    case '1':
                                        if (result.mainFolderUrl) window.open(result.mainFolderUrl, '_blank');
                                        break;
                                    case '2':
                                        if (result.masterListUrl) window.open(result.masterListUrl, '_blank');
                                        break;
                                    case '3':
                                        if (result.adminSheetUrl) window.open(result.adminSheetUrl, '_blank');
                                        break;
                                }
                            }
                        } else {
                            alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
                    })
                    .initializeSystemWeb();
            }
        }

        function openSystemFolder() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                    } else {
                        alert('ç„¡æ³•é–‹å•Ÿç³»çµ±è³‡æ–™å¤¾ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('é–‹å•Ÿè³‡æ–™å¤¾å¤±æ•—ï¼š' + error.message);
                })
                .getSystemFolderUrl();
        }

        function importStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'åŒ¯å…¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                        updateStats();
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('importStudentData');
        }

        function exportStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'åŒ¯å‡ºä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = 'âœ… ' + result.message;
                        if (result.exportUrl) {
                            if (confirm(message + '\n\næ˜¯å¦è¦é–‹å•ŸåŒ¯å‡ºæª”æ¡ˆï¼Ÿ')) {
                                window.open(result.exportUrl, '_blank');
                            }
                        } else {
                            alert(message);
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('exportStudentData');
        }

        function updateTeachersList() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('è€å¸«åˆ—è¡¨æ›´æ–°å®Œæˆï¼');
                        updateStats();
                    } else {
                        alert('æ›´æ–°å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('updateTeachersList');
        }

        function checkAllProgress() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'æª¢æŸ¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayProgressResults(result);
                    } else {
                        alert('æª¢æŸ¥å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('checkAllProgress');
        }
        
        function displayProgressResults(result) {
            if (!result.progressResults || result.progressResults.length === 0) {
                alert('âš ï¸ ' + result.message);
                return;
            }
            
            const summary = result.summary;
            let message = 'ğŸ“Š å…¨é«”è€å¸«é›»è¯é€²åº¦æª¢æŸ¥çµæœ\\n\\n';
            
            // ç¸½é«”çµ±è¨ˆ
            message += `ğŸ“ˆ ç¸½é«”çµ±è¨ˆï¼š\\n`;
            message += `â€¢ è€å¸«ç¸½æ•¸ï¼š${summary.totalTeachers} ä½\\n`;
            message += `â€¢ å­¸ç”Ÿç¸½æ•¸ï¼š${summary.totalStudents} ä½\\n`;
            message += `â€¢ ç´¯è¨ˆé›»è¯è¨˜éŒ„ï¼š${summary.totalContacts} ç­†\\n`;
            message += `â€¢ å­¸æœŸé›»è¯è¨˜éŒ„ï¼š${summary.totalSemesterContacts} ç­†\\n\\n`;
            
            // ç•¶å‰å­¸æœŸtermé€²åº¦
            message += `ğŸ¯ ${summary.currentSemester} ${summary.currentTerm} é€²åº¦ï¼š\\n`;
            message += `â€¢ å·²å®Œæˆï¼š${summary.currentTermCompleted}/${summary.currentTermTotal} ä½å­¸ç”Ÿ\\n`;
            message += `â€¢ å®Œæˆç‡ï¼š${summary.currentTermCompletionRate}%\\n\\n`;
            
            // ç‹€æ…‹åˆ†å¸ƒ
            message += `ğŸ“Š ç‹€æ…‹åˆ†å¸ƒï¼š\\n`;
            message += `â€¢ âœ… æ­£å¸¸ï¼š${summary.normalCount} ä½ (${summary.normalPercentage}%)\\n`;
            message += `â€¢ âš ï¸ å¾…æ”¹å–„ï¼š${summary.needImprovementCount} ä½ (${summary.needImprovementPercentage}%)\\n`;
            message += `â€¢ ğŸš¨ éœ€è¦é—œæ³¨ï¼š${summary.needAttentionCount} ä½ (${summary.needAttentionPercentage}%)\\n\\n`;
            
            // è©³ç´°åˆ—è¡¨
            if (summary.needAttentionCount > 0 || summary.needImprovementCount > 0) {
                message += `ğŸ“‹ éœ€è¦é—œæ³¨çš„è€å¸«ï¼š\\n`;
                result.progressResults.forEach(progress => {
                    if (progress.status !== 'æ­£å¸¸') {
                        message += `\\nâ€¢ ${progress.teacherName} (${progress.status})\\n`;
                        message += `  - å­¸ç”Ÿç¸½æ•¸ï¼š${progress.totalStudents} ä½\\n`;
                        message += `  - å­¸æœŸé›»è¯ï¼š${progress.semesterContacts || 0} ç­†\\n`;
                        if (progress.currentTermProgress) {
                            const remaining = progress.currentTermProgress.total - progress.currentTermProgress.completed;
                            message += `  - ç•¶å‰Termï¼š${progress.currentTermProgress.completed}/${progress.currentTermProgress.total} ä½å­¸ç”Ÿå·²å®Œæˆ\\n`;
                            if (remaining > 0) {
                                message += `  - å¾…é›»è¯ï¼š${remaining} ä½å­¸ç”Ÿ\\n`;
                            }
                        }
                        message += `  - æœ€å¾Œå­¸æœŸé›»è¯ï¼š${progress.lastContactDate}\\n`;
                        if (progress.alertMessage) {
                            message += `  - æé†’ï¼š${progress.alertMessage}\\n`;
                        }
                    }
                });
            } else {
                message += `ğŸ‰ æ‰€æœ‰è€å¸«çš„é›»è¯è¨˜éŒ„ç‹€æ…‹éƒ½å¾ˆè‰¯å¥½ï¼`;
            }
            
            // é¡¯ç¤ºéŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
            if (result.errors && result.errors.length > 0) {
                message += `\\n\\nâš ï¸ æª¢æŸ¥éç¨‹ä¸­çš„å•é¡Œï¼š\\n`;
                result.errors.forEach(error => {
                    message += `â€¢ ${error}\\n`;
                });
            }
            
            alert(message);
        }

        function generateProgressReport() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = 'ğŸ“Š é€²åº¦å ±å‘Šç”Ÿæˆå®Œæˆï¼\\n\\n';
                        message += `â€¢ æª¢æŸ¥äº† ${result.teacherCount} ä½è€å¸«\\n`;
                        message += `â€¢ åŒ…å« ${result.dataCount} ç­†é›»è¯è¨˜éŒ„\\n\\n`;
                        message += 'é»æ“Šã€Œç¢ºå®šã€å¾Œå°‡é–‹å•Ÿå ±å‘Šæª”æ¡ˆã€‚';
                        
                        if (confirm(message)) {
                            window.open(result.reportUrl, '_blank');
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('generateProgressReport');
        }

        function setupAutomation() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¨­å®šä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ è¨­å®šå¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('è¨­å®šå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('setupAutomation');
        }

        function performBackup() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'å‚™ä»½ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ å‚™ä»½å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('å‚™ä»½å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('performBackup');
        }

        function checkFileIntegrity() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('æª”æ¡ˆå®Œæ•´æ€§æª¢æŸ¥å®Œæˆï¼');
                    } else {
                        alert('æª¢æŸ¥å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('checkFileIntegrity');
        }

        function showSystemSettings() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¼‰å…¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displaySystemSettings(result.settings);
                    } else {
                        alert('âŒ è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('showSystemSettings');
        }

        function displaySystemSettings(settings) {
            let settingsHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px;">';
            
            settingsHTML += '<h2 style="color: #333; margin-bottom: 20px;">ğŸ“‹ ç³»çµ±è¨­å®šè³‡è¨Š</h2>';
            
            // ç³»çµ±ç‹€æ…‹
            if (settings.systemStatus) {
                settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px;">';
                settingsHTML += '<h3 style="color: #2c5282; margin-bottom: 10px;">ğŸ¥ ç³»çµ±ç‹€æ…‹</h3>';
                settingsHTML += `<p><strong>å¥åº·åº¦ï¼š</strong> ${settings.systemStatus.overallHealth}%</p>`;
                settingsHTML += `<p><strong>ç‹€æ…‹ï¼š</strong> ${settings.systemStatus.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</p>`;
                settingsHTML += `<p><strong>æè¿°ï¼š</strong> ${settings.systemStatus.statusDescription}</p>`;
                settingsHTML += '</div>';
            }
            
            // ç³»çµ±è³‡æ–™å¤¾è³‡è¨Š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f0fff4; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #2f855a; margin-bottom: 10px;">ğŸ“ è³‡æ–™å¤¾è¨­å®š</h3>';
            settingsHTML += `<p><strong>ä¸»è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.mainFolderName}</p>`;
            settingsHTML += `<p><strong>ä¸»è³‡æ–™å¤¾IDï¼š</strong> ${settings.systemInfo.mainFolderId}</p>`;
            settingsHTML += `<p><strong>è€å¸«è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.teachersFolderName}</p>`;
            settingsHTML += `<p><strong>ç¯„æœ¬è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.templatesFolderName}</p>`;
            if (settings.mainFolderUrl) {
                settingsHTML += `<p><a href="${settings.mainFolderUrl}" target="_blank" style="color: #3182ce; text-decoration: none;">ğŸ”— é–‹å•Ÿä¸»è³‡æ–™å¤¾</a></p>`;
            }
            settingsHTML += '</div>';
            
            // å­¸å¹´è¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fffbf0; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #c05621; margin-bottom: 10px;">ğŸ“… å­¸å¹´è¨­å®š</h3>';
            settingsHTML += `<p><strong>å­¸æœŸï¼š</strong> ${settings.academicYear.semesters.join(', ')}</p>`;
            settingsHTML += `<p><strong>æœŸåˆ¥ï¼š</strong> ${settings.academicYear.terms.join(', ')}</p>`;
            settingsHTML += `<p><strong>ç•¶å‰å­¸æœŸï¼š</strong> ${settings.academicYear.currentSemester}</p>`;
            settingsHTML += `<p><strong>ç•¶å‰æœŸåˆ¥ï¼š</strong> ${settings.academicYear.currentTerm}</p>`;
            settingsHTML += '</div>';
            
            // è¯ç¹«è¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #4a5568; margin-bottom: 10px;">ğŸ“ è¯ç¹«è¨­å®š</h3>';
            settingsHTML += `<p><strong>è¯ç¹«é¡å‹ï¼š</strong> ${Object.values(settings.contactSettings.contactTypes).join(', ')}</p>`;
            settingsHTML += `<p><strong>è¯ç¹«æ–¹å¼ï¼š</strong> ${settings.contactSettings.contactMethods.join(', ')}</p>`;
            settingsHTML += `<p><strong>æ¯æœŸå¿…é ˆè¯ç¹«æ¬¡æ•¸ï¼š</strong> ${settings.contactSettings.requiredContactPerTerm}</p>`;
            settingsHTML += `<p><strong>æé†’å¤©æ•¸ï¼š</strong> ${settings.contactSettings.alertDays}</p>`;
            settingsHTML += '</div>';
            
            // å¹´ç´šè¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fef5e7; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #b7791f; margin-bottom: 10px;">ğŸ“ å¹´ç´šè¨­å®š</h3>';
            settingsHTML += `<p><strong>å¹´ç´šï¼š</strong> ${settings.gradeSettings.gradeLevels.join(', ')}</p>`;
            settingsHTML += `<p><strong>è‹±èªç­ç´šåç¨±ï¼š</strong> ${settings.gradeSettings.englishClassNames.slice(0, 5).join(', ')} ... (å…± ${settings.gradeSettings.englishClassNames.length} å€‹)</p>`;
            settingsHTML += '</div>';
            
            settingsHTML += '<div style="text-align: center; margin-top: 20px;">';
            settingsHTML += '<button onclick="closeSystemSettingsModal()" style="background: #4299e1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é—œé–‰</button>';
            settingsHTML += '</div>';
            
            settingsHTML += '</div>';
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            const modal = document.createElement('div');
            modal.id = 'systemSettingsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 10px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            modalContent.innerHTML = settingsHTML;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function closeSystemSettingsModal() {
            const modal = document.getElementById('systemSettingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========== ç³»çµ±ç‹€æ…‹æª¢æŸ¥å’Œè¨­å®šç›¸é—œå‡½æ•¸ ==========

        function checkSystemStatus() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'æª¢æŸ¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        updateSystemStatusDisplay(result.systemStatus);
                        displaySystemStatusDetails(result.systemStatus);
                    } else {
                        alert('ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                })
                .getSystemStatusWeb();
        }
        
        function setupCompleteSystem() {
            if (confirm('ç¢ºå®šè¦åŸ·è¡Œä¸€éµå®Œæ•´è¨­å®šå—ï¼Ÿ\n\né€™å°‡åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š\nâ€¢ åˆå§‹åŒ–ç”Ÿç”¢ç’°å¢ƒï¼ˆè³‡æ–™å¤¾çµæ§‹ã€ç¯„æœ¬æª”æ¡ˆã€ç®¡ç†æ§åˆ¶å°ï¼‰\nâ€¢ åŸ·è¡Œç³»çµ±å¥åº·æª¢æŸ¥\n\næ•´å€‹éç¨‹éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'è¨­å®šä¸­...';
                button.disabled = true;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        button.textContent = originalText;
                        button.disabled = false;
                        
                        if (result.success) {
                            displayCompleteSetupResults(result);
                            checkSystemStatus(); // é‡æ–°æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                        } else {
                            alert('ä¸€éµè¨­å®šå¤±æ•—ï¼š' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        button.textContent = originalText;
                        button.disabled = false;
                        alert('ä¸€éµè¨­å®šå¤±æ•—ï¼š' + error.message);
                    })
                    .setupCompleteSystemWeb();
            }
        }
        
        function updateSystemStatusDisplay(systemStatus) {
            const indicator = document.getElementById('systemStatusIndicator');
            const quickSetupSection = document.getElementById('quickSetupSection');
            
            let statusColor, statusIcon, statusText, statusMessage;
            
            // æ ¹æ“šå¥åº·åº¦å’Œåˆå§‹åŒ–ç‹€æ…‹è¨­å®šé¡è‰²å’Œè¨Šæ¯
            if (systemStatus.overallHealth === 0) {
                statusColor = '#f8d7da';
                statusIcon = 'âŒ';
                statusText = 'ç³»çµ±å°šæœªåˆå§‹åŒ–';
                statusMessage = 'æ²’æœ‰æ‰¾åˆ°ç³»çµ±è³‡æ–™å¤¾ - éœ€è¦åŸ·è¡Œå®Œæ•´åˆå§‹åŒ–';
            } else if (systemStatus.overallHealth < 50) {
                statusColor = '#fff3cd';
                statusIcon = 'âš ï¸';
                statusText = 'ç³»çµ±éƒ¨åˆ†åˆå§‹åŒ–';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'ç¼ºå°‘é—œéµçµ„ä»¶'}`;
            } else if (systemStatus.overallHealth < 95) {
                statusColor = '#cce7ff';
                statusIcon = 'ğŸ”§';
                statusText = 'ç³»çµ±åŸºæœ¬å°±ç·’';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'ä»éœ€å®Œå–„éƒ¨åˆ†çµ„ä»¶'}`;
            } else {
                statusColor = '#d4edda';
                statusIcon = 'âœ…';
                statusText = 'ç³»çµ±å®Œå…¨å°±ç·’';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'å¯ä»¥æ­£å¸¸ä½¿ç”¨'}`;
            }
            
            // èª¿æ•´å¿«é€Ÿè¨­å®šå€åŸŸé¡¯ç¤ºé‚è¼¯
            if (systemStatus.overallHealth >= 95) {
                // ç³»çµ±å°±ç·’æ™‚é¡¯ç¤ºç¶­è­·é¸é …
                quickSetupSection.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 10px;">ğŸ› ï¸ ç³»çµ±ç¶­è­·</h3>
                        <p style="color: #155724; margin-bottom: 15px;">ç³»çµ±é‹ä½œæ­£å¸¸ã€‚å¦‚éœ€é‡æ–°è¨­å®šæˆ–ç¶­è­·ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹é¸é …ï¼š</p>
                        <button class="action-button secondary" onclick="setupCompleteSystem()" style="margin-right: 10px;">
                            ğŸ”„ å¼·åˆ¶é‡æ–°åˆå§‹åŒ–
                        </button>
                        <button class="action-button secondary" onclick="showDetailedDiagnostic()">
                            ğŸ” è©³ç´°è¨ºæ–·å ±å‘Š
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            } else {
                // ç³»çµ±æœªå°±ç·’æ™‚é¡¯ç¤ºè¨­å®šé¸é …
                quickSetupSection.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 10px;">âš¡ å¿«é€Ÿè¨­å®š</h3>
                        <p style="color: #856404; margin-bottom: 15px;">ç³»çµ±å°šæœªå®Œæ•´åˆå§‹åŒ–ï¼Œå»ºè­°å…ˆåŸ·è¡Œå®Œæ•´è¨­å®šï¼š</p>
                        <button class="action-button primary" onclick="setupCompleteSystem()" style="margin-right: 10px;">
                            ğŸš€ ä¸€éµå®Œæ•´è¨­å®š
                        </button>
                        <button class="action-button secondary" onclick="initializeSystem()">
                            ğŸ—ï¸ åˆå§‹åŒ–ç³»çµ±
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            }
            
            // æ·»åŠ è©³ç´°çš„å»ºè­°ä¿¡æ¯
            let recommendations = '';
            if (systemStatus.recommendations && systemStatus.recommendations.length > 0) {
                recommendations = `<br><small style="opacity: 0.8;">å»ºè­°ï¼š${systemStatus.recommendations[0]}</small>`;
            }
            
            // æ·»åŠ é©—è­‰è©³æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
            let validationDetails = '';
            if (systemStatus.validationDetails && systemStatus.overallHealth < 95) {
                validationDetails = `<br><small style="opacity: 0.7; font-style: italic;">è©³æƒ…ï¼š${systemStatus.validationDetails}</small>`;
            }
            
            const borderColor = statusColor === '#d4edda' ? '#28a745' : 
                               statusColor === '#cce7ff' ? '#007bff' :
                               statusColor === '#fff3cd' ? '#ffc107' : '#dc3545';
            const textColor = statusColor === '#d4edda' ? '#155724' : 
                             statusColor === '#cce7ff' ? '#004085' :
                             statusColor === '#fff3cd' ? '#856404' : '#721c24';
            
            indicator.innerHTML = `
                <div style="background: ${statusColor}; padding: 15px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                    <h3 style="color: ${textColor}; margin-bottom: 10px;">${statusIcon} ${statusText}</h3>
                    <p style="color: ${textColor}; margin: 0;">${statusMessage}${recommendations}${validationDetails}</p>
                </div>
            `;
        }
        
        function displaySystemStatusDetails(systemStatus) {
            let statusDetails = `ğŸ” ç³»çµ±ç‹€æ…‹è©³ç´°å ±å‘Š\n\n`;
            statusDetails += `ğŸ“Š æ•´é«”å¥åº·åº¦ï¼š${systemStatus.overallHealth}%\n`;
            statusDetails += `âœ… ç³»çµ±åˆå§‹åŒ–ï¼š${systemStatus.initialized ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n\n`;
            
            statusDetails += `ğŸ­ ç”Ÿç”¢ç’°å¢ƒç‹€æ…‹ï¼š\n`;
            statusDetails += `â€¢ ä¸»è³‡æ–™å¤¾ï¼š${systemStatus.productionEnvironment.mainFolder ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            statusDetails += `â€¢ å­è³‡æ–™å¤¾ï¼š${systemStatus.productionEnvironment.subFolders ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´'}\n`;
            statusDetails += `â€¢ ç®¡ç†æ§åˆ¶å°ï¼š${systemStatus.productionEnvironment.adminConsole ? 'âœ… å·²å»ºç«‹' : 'âŒ æœªå»ºç«‹'}\n`;
            statusDetails += `â€¢ ç¯„æœ¬æª”æ¡ˆï¼š${systemStatus.productionEnvironment.templates ? 'âœ… å·²å»ºç«‹' : 'âŒ æœªå»ºç«‹'}\n\n`;
            
            statusDetails += `ğŸ’¡ å»ºè­°ï¼š\n`;
            systemStatus.recommendations.forEach(rec => {
                statusDetails += `â€¢ ${rec}\n`;
            });
            
            statusDetails += `\nğŸ“‹ ä¸‹ä¸€æ­¥ï¼š\n`;
            systemStatus.nextSteps.forEach(step => {
                statusDetails += `â€¢ ${step}\n`;
            });
            
            alert(statusDetails);
        }
        
        function displayCompleteSetupResults(result) {
            let message = 'ğŸš€ ä¸€éµå®Œæ•´è¨­å®šçµæœ\n\n';
            
            if (result.success) {
                message += 'âœ… è¨­å®šæˆåŠŸå®Œæˆï¼\n\n';
                message += 'ğŸ“‹ åŸ·è¡Œæ­¥é©Ÿï¼š\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
                
                message += '\nğŸ¯ ç³»çµ±ç¾åœ¨å·²æº–å‚™å°±ç·’ï¼Œæ‚¨å¯ä»¥ï¼š\n';
                message += 'â€¢ é–‹å§‹å»ºç«‹è€å¸«è¨˜éŒ„ç°¿\n';
                message += 'â€¢ åŒ¯å…¥å¯¦éš›å­¸ç”Ÿè³‡æ–™\n';
                message += 'â€¢ åŸ·è¡Œç³»çµ±æ¸¬è©¦é©—è­‰åŠŸèƒ½\n';
            } else {
                message += 'âŒ è¨­å®šéç¨‹ä¸­é‡åˆ°å•é¡Œ\n\n';
                message += 'éŒ¯èª¤è¨Šæ¯ï¼š\n';
                result.setupResults.errors.forEach(error => {
                    message += `â€¢ ${error}\n`;
                });
                
                message += '\nå·²å®Œæˆçš„æ­¥é©Ÿï¼š\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
            }
            
            alert(message);
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        window.addEventListener('DOMContentLoaded', function() {
            // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
            setTimeout(function() {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            updateSystemStatusDisplay(result.systemStatus);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.log('åˆå§‹ç‹€æ…‹æª¢æŸ¥å¤±æ•—ï¼š', error);
                    })
                    .getSystemStatusWeb();
            }, 1000);
        });

        // ========== è©³ç´°ç³»çµ±è¨ºæ–· ==========
        
        function showDetailedDiagnostic() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¨ºæ–·ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayDetailedDiagnostic(result.diagnostic);
                    } else {
                        alert('è©³ç´°è¨ºæ–·å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('è©³ç´°è¨ºæ–·å¤±æ•—ï¼š' + error.message);
                })
                .generateDetailedSystemDiagnosticWeb();
        }
        
        function displayDetailedDiagnostic(diagnostic) {
            let message = `ğŸ¥ è©³ç´°ç³»çµ±è¨ºæ–·å ±å‘Š\\n`;
            message += `ğŸ“… æª¢æŸ¥æ™‚é–“ï¼š${diagnostic.timestamp}\\n\\n`;
            
            // æª¢æŸ¥é …ç›®ç‹€æ…‹
            const checks = [
                { name: 'ğŸŒ Google Drive å­˜å–', item: diagnostic.driveAccess },
                { name: 'ğŸ“ è³‡æ–™å¤¾çµæ§‹', item: diagnostic.folderStructure },
                { name: 'âš™ï¸ ç³»çµ±é…ç½®', item: diagnostic.configurations },
                { name: 'ğŸ”‘ æ“ä½œæ¬Šé™', item: diagnostic.permissions }
            ];
            
            checks.forEach(check => {
                const statusIcon = check.item.status === 'success' ? 'âœ…' : 
                                 check.item.status === 'warning' ? 'âš ï¸' : 'âŒ';
                message += `${statusIcon} ${check.name}\\n`;
                message += `   ${check.item.details}\\n\\n`;
            });
            
            // å»ºè­°äº‹é …
            message += `ğŸ’¡ å»ºè­°äº‹é …ï¼š\\n`;
            diagnostic.recommendations.forEach(rec => {
                message += `â€¢ ${rec}\\n`;
            });
            
            alert(message);
        }

        // ========== ç³»çµ±æ¸¬è©¦ ==========
        
        function executeSystemTest() {
            if (confirm('ç¢ºå®šè¦åŸ·è¡Œç³»çµ±æ¸¬è©¦å—ï¼Ÿ\n\né€™å°‡æ¸¬è©¦ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\nâ€¢ æª¢æŸ¥å…¨é«”é€²åº¦\nâ€¢ ç”Ÿæˆé€²åº¦å ±å‘Š\nâ€¢ åŸ·è¡Œç³»çµ±å‚™ä»½\nâ€¢ æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§\n\næ¸¬è©¦éç¨‹ç´„éœ€2-3åˆ†é˜ã€‚')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'æ¸¬è©¦ä¸­...';
                button.disabled = true;
                
                let testResults = [];
                let currentTest = 0;
                const testSteps = [
                    { name: 'æª¢æŸ¥å…¨é«”é€²åº¦', function: 'checkAllProgress' },
                    { name: 'ç”Ÿæˆé€²åº¦å ±å‘Š', function: 'generateProgressReport' },
                    { name: 'åŸ·è¡Œç³»çµ±å‚™ä»½', function: 'performBackup' },
                    { name: 'æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§', function: 'checkFileIntegrity' }
                ];
                
                function runNextTest() {
                    if (currentTest >= testSteps.length) {
                        // æ‰€æœ‰æ¸¬è©¦å®Œæˆ
                        button.textContent = originalText;
                        button.disabled = false;
                        displaySystemTestSummary(testResults);
                        return;
                    }
                    
                    const step = testSteps[currentTest];
                    button.textContent = `æ¸¬è©¦ä¸­... (${currentTest + 1}/${testSteps.length})`;
                    
                    google.script.run
                        .withSuccessHandler(function(result) {
                            testResults.push({
                                name: step.name,
                                success: result.success,
                                message: result.message || 'å®Œæˆ'
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .withFailureHandler(function(error) {
                            testResults.push({
                                name: step.name,
                                success: false,
                                message: error.message
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .executeSystemFunction(step.function);
                }
                
                runNextTest();
            }
        }
        
        function displaySystemTestSummary(results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            const successRate = Math.round((successCount / totalCount) * 100);
            
            let message = `ğŸ¯ ç³»çµ±æ¸¬è©¦çµæœæ‘˜è¦\\n\\n`;
            message += `ğŸ“Š ç¸½é«”è¡¨ç¾ï¼š${successCount}/${totalCount} é …æ¸¬è©¦é€šé (${successRate}%)\\n\\n`;
            
            message += `ğŸ“‹ è©³ç´°çµæœï¼š\\n`;
            results.forEach((result, index) => {
                const icon = result.success ? 'âœ…' : 'âŒ';
                message += `${icon} ${result.name}\\n`;
                if (!result.success) {
                    message += `   éŒ¯èª¤ï¼š${result.message}\\n`;
                }
            });
            
            if (successRate >= 75) {
                message += `\\nğŸ‰ æ¸¬è©¦è¡¨ç¾å„ªç§€ï¼ç³»çµ±é‹ä½œæ­£å¸¸ã€‚`;
            } else if (successRate >= 50) {
                message += `\\nâš ï¸ æ¸¬è©¦éƒ¨åˆ†é€šéï¼Œå»ºè­°æª¢æŸ¥å¤±æ•—é …ç›®ã€‚`;
            } else {
                message += `\\nğŸš¨ æ¸¬è©¦è¡¨ç¾ä¸ä½³ï¼Œç³»çµ±å¯èƒ½å­˜åœ¨å•é¡Œã€‚\\n`;
                message += `å»ºè­°ï¼šåŸ·è¡Œã€ŒğŸš€ ä¸€éµå®Œæ•´è¨­å®šã€é‡å»ºç³»çµ±ã€‚`;
            }
            
            alert(message);
        }
        

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const stats = result.stats;
                        document.getElementById('teacherCount').textContent = stats.teacherCount;
                        document.getElementById('studentCount').textContent = stats.studentCount;
                        document.getElementById('contactCount').textContent = stats.contactCount;
                        document.getElementById('semesterProgress').textContent = stats.currentTermProgress + '%';
                        document.getElementById('semesterProgressLabel').textContent = `${stats.currentSemester} ${stats.currentTerm}é€²åº¦`;
                    } else {
                        // ä½¿ç”¨é è¨­å€¼
                        document.getElementById('teacherCount').textContent = '0';
                        document.getElementById('studentCount').textContent = '0';
                        document.getElementById('contactCount').textContent = '0';
                        document.getElementById('semesterProgress').textContent = '0%';
                        document.getElementById('semesterProgressLabel').textContent = 'å­¸æœŸé€²åº¦';
                    }
                })
                .withFailureHandler(function(error) {
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä½¿ç”¨é è¨­å€¼
                    document.getElementById('teacherCount').textContent = '0';
                    document.getElementById('studentCount').textContent = '0';
                    document.getElementById('contactCount').textContent = '0';
                    document.getElementById('semesterProgress').textContent = '0%';
                    document.getElementById('semesterProgressLabel').textContent = 'å­¸æœŸé€²åº¦';
                })
                .getSystemStatsWeb();
        }

        // é é¢è¼‰å…¥æ™‚æ›´æ–°çµ±è¨ˆ
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>