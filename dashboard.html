<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電聯記錄簿系統 - 管理面板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #4facfe;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .action-button.primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .action-button.secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1em;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 20px;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 電聯記錄簿系統</h1>
            <p>中師英文科管理面板</p>
        </div>
        
        <div class="main-content">
            <!-- 系統統計 -->
            <div class="section">
                <h2>📊 系統概況</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="teacherCount">0</div>
                        <div class="stat-label">英文老師</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="studentCount">0</div>
                        <div class="stat-label">學生總數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="contactCount">0</div>
                        <div class="stat-label">電聯記錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="semesterProgress">0%</div>
                        <div class="stat-label" id="semesterProgressLabel">學期進度</div>
                    </div>
                </div>
            </div>
            
            <!-- 主要功能 -->
            <div class="section">
                <h2>🚀 主要功能</h2>
                <div class="button-grid">
                    <button class="action-button primary" onclick="showMasterListModal()">
                        📋 從學生總表建立老師記錄簿
                    </button>
                    <button class="action-button" onclick="initializeSystem()">
                        🏗️ 初始化系統
                    </button>
                    <button class="action-button" onclick="showTeacherModal()">
                        👨‍🏫 新增單一老師記錄簿
                    </button>
                    <button class="action-button secondary" onclick="openSystemFolder()">
                        📁 開啟系統資料夾
                    </button>
                </div>
            </div>
            
            <!-- 資料管理 -->
            <div class="section">
                <h2>📝 資料管理</h2>
                <div class="button-grid">
                    <button class="action-button" onclick="importStudentData()">
                        📥 匯入學生資料
                    </button>
                    <button class="action-button" onclick="exportStudentData()">
                        📤 匯出學生資料
                    </button>
                    <button class="action-button" onclick="updateTeachersList()">
                        🔄 更新老師列表
                    </button>
                    <button class="action-button secondary" onclick="checkAllProgress()">
                        📊 檢查全體進度
                    </button>
                    <button class="action-button secondary" onclick="generateProgressReport()">
                        📈 生成進度報告
                    </button>
                </div>
            </div>
            
            <!-- 系統管理 -->
            <div class="section">
                <h2>⚙️ 系統管理</h2>
                <div class="button-grid">
                    <button class="action-button" onclick="setupAutomation()">
                        🔄 設定自動化
                    </button>
                    <button class="action-button" onclick="performBackup()">
                        💾 手動備份
                    </button>
                    <button class="action-button secondary" onclick="checkFileIntegrity()">
                        🔍 檢查檔案完整性
                    </button>
                    <button class="action-button secondary" onclick="showSystemSettings()">
                        ⚙️ 系統設定
                    </button>
                </div>
            </div>
            
            <!-- 系統監控 -->
            <div class="section">
                <h2>📊 系統監控</h2>
                
                <!-- 系統狀態指示 -->
                <div id="systemStatusIndicator" style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h3 style="color: #495057; margin-bottom: 10px;">🔄 檢查系統狀態中...</h3>
                        <p style="color: #6c757d; margin: 0;">正在檢查系統初始化狀態，請稍候...</p>
                    </div>
                </div>
                
                <!-- 快速設定區 - 動態生成 -->
                <div id="quickSetupSection" style="display: none; margin-bottom: 20px;">
                    <!-- 內容由 JavaScript 動態生成 -->
                </div>
                
                <!-- 系統監控工具 -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #495057; margin-bottom: 10px;">🔧 監控工具</h3>
                    <div class="button-grid">
                        <button class="action-button secondary" onclick="checkSystemStatus()">
                            📊 檢查系統狀態
                        </button>
                        <button class="action-button secondary" onclick="executeSystemTest()">
                            🧪 執行系統測試
                        </button>
                    </div>
                </div>
                
                <div class="instructions" style="margin-top: 20px;">
                    <h3>📚 使用說明：</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6;">
                        <p><strong>🔧 監控工具：</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>檢查系統狀態：</strong>驗證系統初始化狀態和健康度</li>
                            <li><strong>執行系統測試：</strong>測試核心功能：進度檢查、報告生成、備份、檔案完整性</li>
                        </ul>
                        <p style="color: #666; font-style: italic; margin-top: 10px;">
                            💡 建議：首次使用或系統更新後執行系統測試驗證功能正常。
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 使用說明 -->
            <div class="section">
                <h2>📖 使用說明</h2>
                <div class="instructions">
                    <h3>快速開始指南：</h3>
                    <ol>
                        <li><strong>系統初始化：</strong>首次使用請點擊「初始化系統」建立基本資料夾結構</li>
                        <li><strong>批量建立：</strong>準備學生總表（包含 LT 欄位），使用「從學生總表建立老師記錄簿」功能</li>
                        <li><strong>資料匯入：</strong>系統會自動從學生總表提取各老師對應的學生資料</li>
                        <li><strong>日常使用：</strong>老師們可直接在各自的記錄簿中進行電聯記錄</li>
                        <li><strong>進度追蹤：</strong>使用「檢查全體進度」監控整體電聯情況</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2024 電聯記錄簿系統 - 專為中師英文科設計</p>
        </div>
    </div>

    <!-- 學生總表匯入模態框 -->
    <div id="masterListModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>📋 從學生總表建立老師記錄簿</h2>
            
            <!-- 選項選擇 -->
            <div class="form-group">
                <label>請選擇學生總表來源：</label>
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="radio" name="masterListSource" value="system" checked style="margin-right: 8px;">
                        🔥 使用系統學生總表（推薦）
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        使用初始化時創建的學生總表，無需輸入 ID
                    </small>
                    
                    <label style="display: block; margin-top: 12px;">
                        <input type="radio" name="masterListSource" value="custom" style="margin-right: 8px;">
                        📋 使用自訂學生總表
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        使用其他 Google Sheets 檔案作為學生總表
                    </small>
                </div>
            </div>
            
            <!-- 自訂 ID 輸入區域 -->
            <div id="customIdSection" class="form-group" style="display: none;">
                <label for="masterListId">學生總表 Google Sheets ID：</label>
                <input type="text" id="masterListId" placeholder="請輸入 Google Sheets 的完整 ID">
                <small style="color: #666; display: block; margin-top: 5px;">
                    範例：從 https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit 中複製 1ABC...XYZ 部分
                </small>
            </div>
            
            <div class="form-group">
                <label>系統要求：</label>
                <ul style="padding-left: 20px; color: #666;">
                    <li>學生總表必須包含 LT (Local Teacher) 欄位</li>
                    <li>包含 English Class 欄位用於班級資訊</li>
                    <li>包含學生基本資料欄位</li>
                </ul>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="processMasterList()" style="margin-right: 10px;">
                    開始處理
                </button>
                <button class="action-button secondary" onclick="closeMasterListModal()">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- 新增老師模態框 -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>👨‍🏫 新增老師記錄簿</h2>
            <div class="form-group">
                <label for="teacherName">老師姓名：</label>
                <input type="text" id="teacherName" placeholder="請輸入老師姓名">
            </div>
            <div class="form-group">
                <label for="teacherClasses">授課班級：</label>
                <input type="text" id="teacherClasses" placeholder="例如：701,702,703（用逗號分隔）">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="createSingleTeacher()" style="margin-right: 10px;">
                    建立記錄簿
                </button>
                <button class="action-button secondary" onclick="closeTeacherModal()">
                    取消
                </button>
            </div>
        </div>
    </div>


    <script>
        // Google Apps Script 部署配置
        const SYSTEM_CONFIG = {
            // MAIN_FOLDER_ID 將從後端動態獲取，不需要硬編碼
            // 直接使用 google.script.run 調用後端函數
        };

        // 模態框控制
        function showMasterListModal() {
            document.getElementById('masterListModal').style.display = 'block';
        }

        function closeMasterListModal() {
            document.getElementById('masterListModal').style.display = 'none';
        }

        function showTeacherModal() {
            document.getElementById('teacherModal').style.display = 'block';
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').style.display = 'none';
        }

        // 點擊模態框外部關閉
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // 關閉按鈕事件
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                this.closest('.modal').style.display = 'none';
            }
        });

        // 處理學生總表來源選擇
        document.addEventListener('change', function(e) {
            if (e.target.name === 'masterListSource') {
                const customSection = document.getElementById('customIdSection');
                if (e.target.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            }
        });

        // 主要功能函數
        function processMasterList() {
            const sourceType = document.querySelector('input[name="masterListSource"]:checked').value;
            let sheetId = '';
            
            if (sourceType === 'custom') {
                sheetId = document.getElementById('masterListId').value.trim();
                if (!sheetId) {
                    alert('請輸入學生總表的 Google Sheets ID');
                    return;
                }
            }
            // 如果是 system，sheetId 保持空字串，後端會自動使用系統學生總表
            
            // 顯示處理中狀態
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '處理中...';
            button.disabled = true;
            
            // 調用完整的 Web 版本功能
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeMasterListModal();
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                        if (result.results && result.results.successCount > 0) {
                            updateStats(); // 更新統計資料
                        }
                    } else {
                        alert('❌ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('❌ 處理失敗：' + error.message);
                })
                .createTeachersFromStudentMasterListWeb(sheetId);
        }

        function createSingleTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const classes = document.getElementById('teacherClasses').value.trim();
            
            if (!name || !classes) {
                alert('請填寫完整的老師資訊');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '建立中...';
            button.disabled = true;
            
            // 準備資料
            const formData = {
                action: 'createSingleTeacher',
                teacherName: name,
                teacherClasses: classes
            };
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeTeacherModal();
                    if (result.success) {
                        alert('老師記錄簿建立成功！\n' + result.message);
                        if (result.recordBookUrl) {
                            if (confirm('是否要開啟新建立的記錄簿？')) {
                                window.open(result.recordBookUrl, '_blank');
                            }
                        }
                    } else {
                        alert('建立失敗：' + result.message);
                    }
                    updateStats();
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('建立失敗：' + error.message);
                })
                .createSingleTeacherWeb(formData);
        }

        function initializeSystem() {
            if (confirm('確定要初始化系統嗎？這將建立必要的資料夾結構。')) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            alert('系統初始化完成！\n' + result.message);
                            
                            // 提供多個選項讓使用者選擇要開啟的檔案
                            const options = [];
                            if (result.mainFolderUrl) options.push('系統主資料夾');
                            if (result.masterListUrl) options.push('學生總表');
                            if (result.adminSheetUrl) options.push('管理控制台');
                            
                            if (options.length > 0) {
                                const choice = prompt('選擇要開啟的檔案：\n1. 系統主資料夾\n2. 學生總表（建議先開啟這個）\n3. 管理控制台\n\n請輸入數字 (1-3)：');
                                
                                switch(choice) {
                                    case '1':
                                        if (result.mainFolderUrl) window.open(result.mainFolderUrl, '_blank');
                                        break;
                                    case '2':
                                        if (result.masterListUrl) window.open(result.masterListUrl, '_blank');
                                        break;
                                    case '3':
                                        if (result.adminSheetUrl) window.open(result.adminSheetUrl, '_blank');
                                        break;
                                }
                            }
                        } else {
                            alert('初始化失敗：' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        alert('初始化失敗：' + error.message);
                    })
                    .initializeSystemWeb();
            }
        }

        function openSystemFolder() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                    } else {
                        alert('無法開啟系統資料夾：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('開啟資料夾失敗：' + error.message);
                })
                .getSystemFolderUrl();
        }

        function importStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '匯入中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                        updateStats();
                    } else {
                        alert('❌ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('❌ 匯入失敗：' + error.message);
                })
                .executeSystemFunction('importStudentData');
        }

        function exportStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '匯出中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = '✅ ' + result.message;
                        if (result.exportUrl) {
                            if (confirm(message + '\n\n是否要開啟匯出檔案？')) {
                                window.open(result.exportUrl, '_blank');
                            }
                        } else {
                            alert(message);
                        }
                    } else {
                        alert('❌ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('❌ 匯出失敗：' + error.message);
                })
                .executeSystemFunction('exportStudentData');
        }

        function updateTeachersList() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('老師列表更新完成！');
                        updateStats();
                    } else {
                        alert('更新失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('更新失敗：' + error.message);
                })
                .executeSystemFunction('updateTeachersList');
        }

        function checkAllProgress() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '檢查中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayProgressResults(result);
                    } else {
                        alert('檢查失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('檢查失敗：' + error.message);
                })
                .executeSystemFunction('checkAllProgress');
        }
        
        function displayProgressResults(result) {
            if (!result.progressResults || result.progressResults.length === 0) {
                alert('⚠️ ' + result.message);
                return;
            }
            
            const summary = result.summary;
            let message = '📊 全體老師電聯進度檢查結果\\n\\n';
            
            // 總體統計
            message += `📈 總體統計：\\n`;
            message += `• 老師總數：${summary.totalTeachers} 位\\n`;
            message += `• 學生總數：${summary.totalStudents} 位\\n`;
            message += `• 累計電聯記錄：${summary.totalContacts} 筆\\n`;
            message += `• 學期電聯記錄：${summary.totalSemesterContacts} 筆\\n\\n`;
            
            // 當前學期term進度
            message += `🎯 ${summary.currentSemester} ${summary.currentTerm} 進度：\\n`;
            message += `• 已完成：${summary.currentTermCompleted}/${summary.currentTermTotal} 位學生\\n`;
            message += `• 完成率：${summary.currentTermCompletionRate}%\\n\\n`;
            
            // 狀態分布
            message += `📊 狀態分布：\\n`;
            message += `• ✅ 正常：${summary.normalCount} 位 (${summary.normalPercentage}%)\\n`;
            message += `• ⚠️ 待改善：${summary.needImprovementCount} 位 (${summary.needImprovementPercentage}%)\\n`;
            message += `• 🚨 需要關注：${summary.needAttentionCount} 位 (${summary.needAttentionPercentage}%)\\n\\n`;
            
            // 詳細列表
            if (summary.needAttentionCount > 0 || summary.needImprovementCount > 0) {
                message += `📋 需要關注的老師：\\n`;
                result.progressResults.forEach(progress => {
                    if (progress.status !== '正常') {
                        message += `\\n• ${progress.teacherName} (${progress.status})\\n`;
                        message += `  - 學生總數：${progress.totalStudents} 位\\n`;
                        message += `  - 學期電聯：${progress.semesterContacts || 0} 筆\\n`;
                        if (progress.currentTermProgress) {
                            const remaining = progress.currentTermProgress.total - progress.currentTermProgress.completed;
                            message += `  - 當前Term：${progress.currentTermProgress.completed}/${progress.currentTermProgress.total} 位學生已完成\\n`;
                            if (remaining > 0) {
                                message += `  - 待電聯：${remaining} 位學生\\n`;
                            }
                        }
                        message += `  - 最後學期電聯：${progress.lastContactDate}\\n`;
                        if (progress.alertMessage) {
                            message += `  - 提醒：${progress.alertMessage}\\n`;
                        }
                    }
                });
            } else {
                message += `🎉 所有老師的電聯記錄狀態都很良好！`;
            }
            
            // 顯示錯誤（如果有）
            if (result.errors && result.errors.length > 0) {
                message += `\\n\\n⚠️ 檢查過程中的問題：\\n`;
                result.errors.forEach(error => {
                    message += `• ${error}\\n`;
                });
            }
            
            alert(message);
        }

        function generateProgressReport() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '生成中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = '📊 進度報告生成完成！\\n\\n';
                        message += `• 檢查了 ${result.teacherCount} 位老師\\n`;
                        message += `• 包含 ${result.dataCount} 筆電聯記錄\\n\\n`;
                        message += '點擊「確定」後將開啟報告檔案。';
                        
                        if (confirm(message)) {
                            window.open(result.reportUrl, '_blank');
                        }
                    } else {
                        alert('❌ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('生成失敗：' + error.message);
                })
                .executeSystemFunction('generateProgressReport');
        }

        function setupAutomation() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '設定中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                    } else {
                        alert('❌ 設定失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('設定失敗：' + error.message);
                })
                .executeSystemFunction('setupAutomation');
        }

        function performBackup() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '備份中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                    } else {
                        alert('❌ 備份失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('備份失敗：' + error.message);
                })
                .executeSystemFunction('performBackup');
        }

        function checkFileIntegrity() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('檔案完整性檢查完成！');
                    } else {
                        alert('檢查失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('檢查失敗：' + error.message);
                })
                .executeSystemFunction('checkFileIntegrity');
        }

        function showSystemSettings() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '載入中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displaySystemSettings(result.settings);
                    } else {
                        alert('❌ 載入系統設定失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('❌ 載入系統設定失敗：' + error.message);
                })
                .executeSystemFunction('showSystemSettings');
        }

        function displaySystemSettings(settings) {
            let settingsHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px;">';
            
            settingsHTML += '<h2 style="color: #333; margin-bottom: 20px;">📋 系統設定資訊</h2>';
            
            // 系統狀態
            if (settings.systemStatus) {
                settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px;">';
                settingsHTML += '<h3 style="color: #2c5282; margin-bottom: 10px;">🏥 系統狀態</h3>';
                settingsHTML += `<p><strong>健康度：</strong> ${settings.systemStatus.overallHealth}%</p>`;
                settingsHTML += `<p><strong>狀態：</strong> ${settings.systemStatus.initialized ? '已初始化' : '未初始化'}</p>`;
                settingsHTML += `<p><strong>描述：</strong> ${settings.systemStatus.statusDescription}</p>`;
                settingsHTML += '</div>';
            }
            
            // 系統資料夾資訊
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f0fff4; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #2f855a; margin-bottom: 10px;">📁 資料夾設定</h3>';
            settingsHTML += `<p><strong>主資料夾：</strong> ${settings.systemInfo.mainFolderName}</p>`;
            settingsHTML += `<p><strong>主資料夾ID：</strong> ${settings.systemInfo.mainFolderId}</p>`;
            settingsHTML += `<p><strong>老師資料夾：</strong> ${settings.systemInfo.teachersFolderName}</p>`;
            settingsHTML += `<p><strong>範本資料夾：</strong> ${settings.systemInfo.templatesFolderName}</p>`;
            if (settings.mainFolderUrl) {
                settingsHTML += `<p><a href="${settings.mainFolderUrl}" target="_blank" style="color: #3182ce; text-decoration: none;">🔗 開啟主資料夾</a></p>`;
            }
            settingsHTML += '</div>';
            
            // 學年設定
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fffbf0; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #c05621; margin-bottom: 10px;">📅 學年設定</h3>';
            settingsHTML += `<p><strong>學期：</strong> ${settings.academicYear.semesters.join(', ')}</p>`;
            settingsHTML += `<p><strong>期別：</strong> ${settings.academicYear.terms.join(', ')}</p>`;
            settingsHTML += `<p><strong>當前學期：</strong> ${settings.academicYear.currentSemester}</p>`;
            settingsHTML += `<p><strong>當前期別：</strong> ${settings.academicYear.currentTerm}</p>`;
            settingsHTML += '</div>';
            
            // 聯繫設定
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #4a5568; margin-bottom: 10px;">📞 聯繫設定</h3>';
            settingsHTML += `<p><strong>聯繫類型：</strong> ${Object.values(settings.contactSettings.contactTypes).join(', ')}</p>`;
            settingsHTML += `<p><strong>聯繫方式：</strong> ${settings.contactSettings.contactMethods.join(', ')}</p>`;
            settingsHTML += `<p><strong>每期必須聯繫次數：</strong> ${settings.contactSettings.requiredContactPerTerm}</p>`;
            settingsHTML += `<p><strong>提醒天數：</strong> ${settings.contactSettings.alertDays}</p>`;
            settingsHTML += '</div>';
            
            // 年級設定
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fef5e7; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #b7791f; margin-bottom: 10px;">🎓 年級設定</h3>';
            settingsHTML += `<p><strong>年級：</strong> ${settings.gradeSettings.gradeLevels.join(', ')}</p>`;
            settingsHTML += `<p><strong>英語班級名稱：</strong> ${settings.gradeSettings.englishClassNames.slice(0, 5).join(', ')} ... (共 ${settings.gradeSettings.englishClassNames.length} 個)</p>`;
            settingsHTML += '</div>';
            
            settingsHTML += '<div style="text-align: center; margin-top: 20px;">';
            settingsHTML += '<button onclick="closeSystemSettingsModal()" style="background: #4299e1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">關閉</button>';
            settingsHTML += '</div>';
            
            settingsHTML += '</div>';
            
            // 創建模態框
            const modal = document.createElement('div');
            modal.id = 'systemSettingsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 10px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            modalContent.innerHTML = settingsHTML;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function closeSystemSettingsModal() {
            const modal = document.getElementById('systemSettingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========== 系統狀態檢查和設定相關函數 ==========

        function checkSystemStatus() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '檢查中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        updateSystemStatusDisplay(result.systemStatus);
                        displaySystemStatusDetails(result.systemStatus);
                    } else {
                        alert('系統狀態檢查失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('系統狀態檢查失敗：' + error.message);
                })
                .getSystemStatusWeb();
        }
        
        function setupCompleteSystem() {
            if (confirm('確定要執行一鍵完整設定嗎？\n\n這將執行以下步驟：\n• 初始化生產環境（資料夾結構、範本檔案、管理控制台）\n• 執行系統健康檢查\n\n整個過程需要幾分鐘時間。')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '設定中...';
                button.disabled = true;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        button.textContent = originalText;
                        button.disabled = false;
                        
                        if (result.success) {
                            displayCompleteSetupResults(result);
                            checkSystemStatus(); // 重新檢查系統狀態
                        } else {
                            alert('一鍵設定失敗：' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        button.textContent = originalText;
                        button.disabled = false;
                        alert('一鍵設定失敗：' + error.message);
                    })
                    .setupCompleteSystemWeb();
            }
        }
        
        function updateSystemStatusDisplay(systemStatus) {
            const indicator = document.getElementById('systemStatusIndicator');
            const quickSetupSection = document.getElementById('quickSetupSection');
            
            let statusColor, statusIcon, statusText, statusMessage;
            
            // 根據健康度和初始化狀態設定顏色和訊息
            if (systemStatus.overallHealth === 0) {
                statusColor = '#f8d7da';
                statusIcon = '❌';
                statusText = '系統尚未初始化';
                statusMessage = '沒有找到系統資料夾 - 需要執行完整初始化';
            } else if (systemStatus.overallHealth < 50) {
                statusColor = '#fff3cd';
                statusIcon = '⚠️';
                statusText = '系統部分初始化';
                statusMessage = `健康度：${systemStatus.overallHealth}% - ${systemStatus.statusDescription || '缺少關鍵組件'}`;
            } else if (systemStatus.overallHealth < 95) {
                statusColor = '#cce7ff';
                statusIcon = '🔧';
                statusText = '系統基本就緒';
                statusMessage = `健康度：${systemStatus.overallHealth}% - ${systemStatus.statusDescription || '仍需完善部分組件'}`;
            } else {
                statusColor = '#d4edda';
                statusIcon = '✅';
                statusText = '系統完全就緒';
                statusMessage = `健康度：${systemStatus.overallHealth}% - ${systemStatus.statusDescription || '可以正常使用'}`;
            }
            
            // 調整快速設定區域顯示邏輯
            if (systemStatus.overallHealth >= 95) {
                // 系統就緒時顯示維護選項
                quickSetupSection.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 10px;">🛠️ 系統維護</h3>
                        <p style="color: #155724; margin-bottom: 15px;">系統運作正常。如需重新設定或維護，可使用以下選項：</p>
                        <button class="action-button secondary" onclick="setupCompleteSystem()" style="margin-right: 10px;">
                            🔄 強制重新初始化
                        </button>
                        <button class="action-button secondary" onclick="showDetailedDiagnostic()">
                            🔍 詳細診斷報告
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            } else {
                // 系統未就緒時顯示設定選項
                quickSetupSection.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 10px;">⚡ 快速設定</h3>
                        <p style="color: #856404; margin-bottom: 15px;">系統尚未完整初始化，建議先執行完整設定：</p>
                        <button class="action-button primary" onclick="setupCompleteSystem()" style="margin-right: 10px;">
                            🚀 一鍵完整設定
                        </button>
                        <button class="action-button secondary" onclick="initializeSystem()">
                            🏗️ 初始化系統
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            }
            
            // 添加詳細的建議信息
            let recommendations = '';
            if (systemStatus.recommendations && systemStatus.recommendations.length > 0) {
                recommendations = `<br><small style="opacity: 0.8;">建議：${systemStatus.recommendations[0]}</small>`;
            }
            
            // 添加驗證詳情（如果有）
            let validationDetails = '';
            if (systemStatus.validationDetails && systemStatus.overallHealth < 95) {
                validationDetails = `<br><small style="opacity: 0.7; font-style: italic;">詳情：${systemStatus.validationDetails}</small>`;
            }
            
            const borderColor = statusColor === '#d4edda' ? '#28a745' : 
                               statusColor === '#cce7ff' ? '#007bff' :
                               statusColor === '#fff3cd' ? '#ffc107' : '#dc3545';
            const textColor = statusColor === '#d4edda' ? '#155724' : 
                             statusColor === '#cce7ff' ? '#004085' :
                             statusColor === '#fff3cd' ? '#856404' : '#721c24';
            
            indicator.innerHTML = `
                <div style="background: ${statusColor}; padding: 15px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                    <h3 style="color: ${textColor}; margin-bottom: 10px;">${statusIcon} ${statusText}</h3>
                    <p style="color: ${textColor}; margin: 0;">${statusMessage}${recommendations}${validationDetails}</p>
                </div>
            `;
        }
        
        function displaySystemStatusDetails(systemStatus) {
            let statusDetails = `🔍 系統狀態詳細報告\n\n`;
            statusDetails += `📊 整體健康度：${systemStatus.overallHealth}%\n`;
            statusDetails += `✅ 系統初始化：${systemStatus.initialized ? '已完成' : '未完成'}\n\n`;
            
            statusDetails += `🏭 生產環境狀態：\n`;
            statusDetails += `• 主資料夾：${systemStatus.productionEnvironment.mainFolder ? '✅ 存在' : '❌ 不存在'}\n`;
            statusDetails += `• 子資料夾：${systemStatus.productionEnvironment.subFolders ? '✅ 完整' : '❌ 不完整'}\n`;
            statusDetails += `• 管理控制台：${systemStatus.productionEnvironment.adminConsole ? '✅ 已建立' : '❌ 未建立'}\n`;
            statusDetails += `• 範本檔案：${systemStatus.productionEnvironment.templates ? '✅ 已建立' : '❌ 未建立'}\n\n`;
            
            statusDetails += `💡 建議：\n`;
            systemStatus.recommendations.forEach(rec => {
                statusDetails += `• ${rec}\n`;
            });
            
            statusDetails += `\n📋 下一步：\n`;
            systemStatus.nextSteps.forEach(step => {
                statusDetails += `• ${step}\n`;
            });
            
            alert(statusDetails);
        }
        
        function displayCompleteSetupResults(result) {
            let message = '🚀 一鍵完整設定結果\n\n';
            
            if (result.success) {
                message += '✅ 設定成功完成！\n\n';
                message += '📋 執行步驟：\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
                
                message += '\n🎯 系統現在已準備就緒，您可以：\n';
                message += '• 開始建立老師記錄簿\n';
                message += '• 匯入實際學生資料\n';
                message += '• 執行系統測試驗證功能\n';
            } else {
                message += '❌ 設定過程中遇到問題\n\n';
                message += '錯誤訊息：\n';
                result.setupResults.errors.forEach(error => {
                    message += `• ${error}\n`;
                });
                
                message += '\n已完成的步驟：\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
            }
            
            alert(message);
        }
        
        // 頁面載入時自動檢查系統狀態
        window.addEventListener('DOMContentLoaded', function() {
            // 延遲執行以確保頁面完全載入
            setTimeout(function() {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            updateSystemStatusDisplay(result.systemStatus);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.log('初始狀態檢查失敗：', error);
                    })
                    .getSystemStatusWeb();
            }, 1000);
        });

        // ========== 詳細系統診斷 ==========
        
        function showDetailedDiagnostic() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '診斷中...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayDetailedDiagnostic(result.diagnostic);
                    } else {
                        alert('詳細診斷失敗：' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('詳細診斷失敗：' + error.message);
                })
                .generateDetailedSystemDiagnosticWeb();
        }
        
        function displayDetailedDiagnostic(diagnostic) {
            let message = `🏥 詳細系統診斷報告\\n`;
            message += `📅 檢查時間：${diagnostic.timestamp}\\n\\n`;
            
            // 檢查項目狀態
            const checks = [
                { name: '🌐 Google Drive 存取', item: diagnostic.driveAccess },
                { name: '📁 資料夾結構', item: diagnostic.folderStructure },
                { name: '⚙️ 系統配置', item: diagnostic.configurations },
                { name: '🔑 操作權限', item: diagnostic.permissions }
            ];
            
            checks.forEach(check => {
                const statusIcon = check.item.status === 'success' ? '✅' : 
                                 check.item.status === 'warning' ? '⚠️' : '❌';
                message += `${statusIcon} ${check.name}\\n`;
                message += `   ${check.item.details}\\n\\n`;
            });
            
            // 建議事項
            message += `💡 建議事項：\\n`;
            diagnostic.recommendations.forEach(rec => {
                message += `• ${rec}\\n`;
            });
            
            alert(message);
        }

        // ========== 系統測試 ==========
        
        function executeSystemTest() {
            if (confirm('確定要執行系統測試嗎？\n\n這將測試以下核心功能：\n• 檢查全體進度\n• 生成進度報告\n• 執行系統備份\n• 檢查檔案完整性\n\n測試過程約需2-3分鐘。')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '測試中...';
                button.disabled = true;
                
                let testResults = [];
                let currentTest = 0;
                const testSteps = [
                    { name: '檢查全體進度', function: 'checkAllProgress' },
                    { name: '生成進度報告', function: 'generateProgressReport' },
                    { name: '執行系統備份', function: 'performBackup' },
                    { name: '檢查檔案完整性', function: 'checkFileIntegrity' }
                ];
                
                function runNextTest() {
                    if (currentTest >= testSteps.length) {
                        // 所有測試完成
                        button.textContent = originalText;
                        button.disabled = false;
                        displaySystemTestSummary(testResults);
                        return;
                    }
                    
                    const step = testSteps[currentTest];
                    button.textContent = `測試中... (${currentTest + 1}/${testSteps.length})`;
                    
                    google.script.run
                        .withSuccessHandler(function(result) {
                            testResults.push({
                                name: step.name,
                                success: result.success,
                                message: result.message || '完成'
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .withFailureHandler(function(error) {
                            testResults.push({
                                name: step.name,
                                success: false,
                                message: error.message
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .executeSystemFunction(step.function);
                }
                
                runNextTest();
            }
        }
        
        function displaySystemTestSummary(results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            const successRate = Math.round((successCount / totalCount) * 100);
            
            let message = `🎯 系統測試結果摘要\\n\\n`;
            message += `📊 總體表現：${successCount}/${totalCount} 項測試通過 (${successRate}%)\\n\\n`;
            
            message += `📋 詳細結果：\\n`;
            results.forEach((result, index) => {
                const icon = result.success ? '✅' : '❌';
                message += `${icon} ${result.name}\\n`;
                if (!result.success) {
                    message += `   錯誤：${result.message}\\n`;
                }
            });
            
            if (successRate >= 75) {
                message += `\\n🎉 測試表現優秀！系統運作正常。`;
            } else if (successRate >= 50) {
                message += `\\n⚠️ 測試部分通過，建議檢查失敗項目。`;
            } else {
                message += `\\n🚨 測試表現不佳，系統可能存在問題。\\n`;
                message += `建議：執行「🚀 一鍵完整設定」重建系統。`;
            }
            
            alert(message);
        }
        

        // 更新統計資料
        function updateStats() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const stats = result.stats;
                        document.getElementById('teacherCount').textContent = stats.teacherCount;
                        document.getElementById('studentCount').textContent = stats.studentCount;
                        document.getElementById('contactCount').textContent = stats.contactCount;
                        document.getElementById('semesterProgress').textContent = stats.currentTermProgress + '%';
                        document.getElementById('semesterProgressLabel').textContent = `${stats.currentSemester} ${stats.currentTerm}進度`;
                    } else {
                        // 使用預設值
                        document.getElementById('teacherCount').textContent = '0';
                        document.getElementById('studentCount').textContent = '0';
                        document.getElementById('contactCount').textContent = '0';
                        document.getElementById('semesterProgress').textContent = '0%';
                        document.getElementById('semesterProgressLabel').textContent = '學期進度';
                    }
                })
                .withFailureHandler(function(error) {
                    // 發生錯誤時使用預設值
                    document.getElementById('teacherCount').textContent = '0';
                    document.getElementById('studentCount').textContent = '0';
                    document.getElementById('contactCount').textContent = '0';
                    document.getElementById('semesterProgress').textContent = '0%';
                    document.getElementById('semesterProgressLabel').textContent = '學期進度';
                })
                .getSystemStatsWeb();
        }

        // 頁面載入時更新統計
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>