<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»è¯è¨˜éŒ„ç°¿ç³»çµ± - ç®¡ç†é¢æ¿</title>
    <meta name="description" content="Parent-teacher communication tracking system dashboard">
    <meta name="theme-color" content="#4facfe">
    <style>
        /* ===== CSS CUSTOM PROPERTIES ===== */
        :root {
            /* Color Palette */
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --soft-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            
            /* Semantic Colors */
            --color-primary: #4facfe;
            --color-secondary: #667eea;
            --color-success: #28a745;
            --color-warning: #fd7e14;
            --color-danger: #dc3545;
            --color-info: #17a2b8;
            
            /* Grayscale */
            --color-dark: #333;
            --color-medium: #6c757d;
            --color-light: #f8f9fa;
            --color-white: #ffffff;
            
            /* Spacing System */
            --spacing-xs: 0.25rem; /* 4px */
            --spacing-sm: 0.5rem;  /* 8px */
            --spacing-md: 1rem;    /* 16px */
            --spacing-lg: 1.5rem;  /* 24px */
            --spacing-xl: 2rem;    /* 32px */
            --spacing-xxl: 2.5rem; /* 40px */
            
            /* Typography */
            --font-family-base: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            --font-size-title: 2.5rem;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.1);
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ===== COMPONENT BASE STYLES ===== */
        body {
            font-family: var(--font-family-base);
            background: var(--secondary-gradient);
            min-height: 100vh;
            padding: var(--spacing-lg);
            line-height: 1.6;
            color: var(--color-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
            }
        }
        
        /* ===== COMPONENT: APP CONTAINER ===== */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: slideInUp 0.6s ease-out;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .app-container {
                border-radius: var(--radius-lg);
            }
        }
        
        @media (max-width: 480px) {
            .app-container {
                border-radius: var(--radius-md);
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Legacy container class - redirected to app-container */
        .container {
            /* This class is now handled by .app-container */
        }
        
        /* ===== COMPONENT: APP HEADER ===== */
        .app-header {
            background: var(--primary-gradient);
            color: var(--color-white);
            padding: var(--spacing-xxl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            pointer-events: none;
        }
        
        .app-title {
            font-size: var(--font-size-title);
            margin-bottom: var(--spacing-sm);
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .app-subtitle {
            font-size: var(--font-size-lg);
            opacity: 0.9;
            position: relative;
            z-index: 1;
            font-weight: 300;
        }
        
        /* Legacy header classes */
        .header { /* Redirected to app-header */ }
        .header h1 { /* Redirected to app-title */ }
        .header p { /* Redirected to app-subtitle */ }
        
        /* ===== COMPONENT: MAIN CONTENT AREA ===== */
        .main-content {
            padding: var(--spacing-xxl);
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: var(--spacing-lg);
            }
        }
        
        /* ===== COMPONENT: CONTENT SECTION ===== */
        .content-section {
            margin-bottom: var(--spacing-xxl);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            background: var(--color-light);
            border-left: 4px solid var(--color-primary);
            transition: var(--transition-base);
            position: relative;
        }
        
        .content-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .section-title {
            color: var(--color-dark);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xxl);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .section-icon {
            font-size: 1.2em;
            opacity: 0.8;
        }
        
        /* ===== COMPONENT: SECTION SYSTEM ===== */
        .section {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
        }
        
        .section h2 {
            color: var(--color-dark);
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .section-description {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--color-primary);
        }
        
        /* ===== COMPONENT: BUTTON GRID SYSTEM ===== */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: var(--spacing-md);
            }
        }
        
        @media (max-width: 640px) {
            .button-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
        }
        
        @media (max-width: 480px) {
            .button-grid {
                gap: var(--spacing-sm);
                margin-top: var(--spacing-md);
            }
        }
        
        /* ===== COMPONENT: ACTION BUTTON SYSTEM ===== */
        .action-button {
            background: var(--secondary-gradient);
            color: var(--color-white);
            padding: var(--spacing-xl);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 500;
            transition: var(--transition-base);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 90px;
            position: relative;
            overflow: hidden;
            font-family: var(--font-family-base);
            text-align: center;
            word-wrap: break-word;
            hyphens: auto;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 640px) {
            .action-button {
                min-height: 80px;
                padding: var(--spacing-lg);
                font-size: var(--font-size-sm);
            }
        }
        
        @media (max-width: 480px) {
            .action-button {
                min-height: 70px;
                padding: var(--spacing-md);
                font-size: var(--font-size-sm);
            }
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }
        
        .action-button:hover::before {
            left: 100%;
        }
        
        .action-button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-button:active {
            transform: translateY(-2px);
            transition: var(--transition-fast);
        }
        
        /* Button Variants */
        .action-button--primary {
            background: var(--accent-gradient);
        }
        
        .action-button--secondary {
            background: var(--soft-gradient);
            color: var(--color-dark);
        }
        
        .action-button--success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .action-button--warning {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        }
        
        .action-button--danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        }
        
        /* Legacy button classes */
        .action-button.primary {
            background: var(--accent-gradient);
        }
        
        .action-button.secondary {
            background: var(--soft-gradient);
            color: var(--color-dark);
        }
        
        .action-button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        }
        
        .action-button.warning {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1em;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 20px;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }
        
        .class-info-display {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4facfe;
            font-size: 0.9em;
            display: none;
        }
        
        .class-info-display.show {
            display: block;
        }
        
        .class-info-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }
        
        /* å­¸ç”Ÿç•°å‹•ç®¡ç†æ¨£å¼ */
        .student-search-container {
            margin-bottom: 20px;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .search-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .search-button {
            padding: 12px 20px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        .search-button:hover {
            background: #3d8bfe;
        }
        
        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #333;
            margin-top: 10px;
        }
        
        /* æˆåŠŸæç¤ºæ¨£å¼ */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 30px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -70%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .success-popup h3 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .success-popup p {
            color: #155724;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .success-popup .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .success-popup .btn-success:hover {
            background: #218838;
        }
        
        /* éŒ¯èª¤æç¤ºæ¨£å¼ */
        .error-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 30px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        .error-popup h3 {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .error-popup p {
            color: #721c24;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-popup .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .error-popup .btn-danger:hover {
            background: #c82333;
        }
        
        .search-results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .search-results.show {
            display: block;
        }
        
        .student-card {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .student-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .change-operations, .change-history {
            margin-bottom: 20px;
        }
        
        .change-operations h3, .change-history h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        /* Legacy danger and warning buttons handled above */
        
        /* ç•°å‹•è¡¨å–®æ¨¡æ…‹æ¡† */
        .change-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .change-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .change-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .change-modal-header h3 {
            margin: 0;
            color: #495057;
        }
        
        .change-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .change-modal-close:hover {
            color: #000;
        }
        
        .change-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .change-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .change-form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        
        .change-form-actions .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .change-form-actions .btn-primary:hover {
            background: #0056b3;
        }
        
        .change-form-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .change-form-actions .btn-secondary:hover {
            background: #545b62;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stage-selector {
                flex-direction: column;
                gap: 15px;
            }
            
            .selector-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
        
        /* å­¸æœŸéšæ®µé¸æ“‡å™¨æ¨£å¼ */
        .stage-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .selector-group label {
            font-weight: 600;
            color: #495057;
            min-width: 50px;
        }
        
        .stage-select {
            padding: 8px 12px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stage-select:hover {
            border-color: #4facfe;
        }
        
        .stage-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .update-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        
        .update-btn:active {
            transform: translateY(0);
        }
        
        /* ===== FUNCTION STATUS INDICATORS ===== */
        .function-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .status-available {
            background-color: #28a745;
            color: white;
        }
        
        .status-checking {
            background-color: #ffc107;
            color: #212529;
        }
        
        .status-unavailable {
            background-color: #dc3545;
            color: white;
        }
        
        .function-tooltip {
            position: absolute;
            bottom: -25px;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .action-button:hover .function-tooltip {
            opacity: 1;
        }
        
        .button-with-status {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š é›»è¯è¨˜éŒ„ç°¿ç³»çµ±</h1>
            <p>ä¸­å¸«è‹±æ–‡ç§‘ç®¡ç†é¢æ¿</p>
        </div>
        
        <div class="main-content">
            <!-- ç³»çµ±çµ±è¨ˆ -->
            <div class="section">
                <h2>ğŸ“Š ç³»çµ±æ¦‚æ³</h2>
                
                <!-- å­¸æœŸéšæ®µé¸æ“‡å™¨ -->
                <div class="stage-selector">
                    <div class="selector-group">
                        <label for="semesterSelect">å­¸æœŸï¼š</label>
                        <select id="semesterSelect" class="stage-select">
                            <option value="Fall">Fall</option>
                            <option value="Spring">Spring</option>
                        </select>
                    </div>
                    <div class="selector-group">
                        <label for="termSelect">éšæ®µï¼š</label>
                        <select id="termSelect" class="stage-select">
                            <option value="Beginning">Beginning</option>
                            <option value="Midterm">Midterm</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    <button id="updateStatsBtn" class="update-btn">æ›´æ–°çµ±è¨ˆ</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="teacherCount">0</div>
                        <div class="stat-label">è‹±æ–‡è€å¸«</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="studentCount">0</div>
                        <div class="stat-label">å­¸ç”Ÿç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="contactCount">0</div>
                        <div class="stat-label">å·²å®Œæˆé›»è¯æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="semesterProgress">0%</div>
                        <div class="stat-label" id="semesterProgressLabel">å­¸æœŸé€²åº¦</div>
                    </div>
                </div>
            </div>
            
            <!-- 1. ç³»çµ±åˆå§‹åŒ– (é¦–æ¬¡ä½¿ç”¨) -->
            <div class="section">
                <h2>ğŸš€ ç³»çµ±åˆå§‹åŒ–</h2>
                <p class="section-description">é¦–æ¬¡ä½¿ç”¨ç³»çµ±å‰ï¼Œè«‹åŸ·è¡Œä¸€éµå®Œæ•´è¨­å®š</p>
                <div class="button-grid">
                    <button class="action-button primary button-with-status" onclick="setupCompleteSystem()" data-function="setupCompleteSystem">
                        ğŸš€ ä¸€éµå®Œæ•´è¨­å®š
                        <span class="function-status status-available"></span>
                        <span class="function-tooltip">æ ¸å¿ƒåŠŸèƒ½ - åŒ…å«åˆå§‹åŒ–å’Œç³»çµ±æª¢æŸ¥</span>
                    </button>
                </div>
            </div>
            
            <!-- 2. æ ¸å¿ƒåŠŸèƒ½ (ä¸»è¦å·¥ä½œæµç¨‹) -->
            <div class="section">
                <h2>ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½</h2>
                <p class="section-description">ä¸»è¦çš„ç³»çµ±åŠŸèƒ½å’Œæ—¥å¸¸æ“ä½œ</p>
                <div class="button-grid">
                    <button class="action-button action-button--primary primary button-with-status" onclick="showMasterListModal()" data-function="processMasterList">
                        ğŸ“‹ å¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿
                        <span class="function-status status-available"></span>
                        <span class="function-tooltip">æ ¸å¿ƒåŠŸèƒ½ - å¯ç”¨</span>
                    </button>
                    <button class="action-button button-with-status" onclick="showTeacherModal()" data-function="createSingleTeacher">
                        ğŸ‘¨â€ğŸ« æ–°å¢å–®ä¸€è€å¸«è¨˜éŒ„ç°¿
                        <span class="function-status status-available"></span>
                        <span class="function-tooltip">æ ¸å¿ƒåŠŸèƒ½ - å¯ç”¨</span>
                    </button>
                    <button class="action-button button-with-status" onclick="importStudentData()" data-function="importStudentData">
                        ğŸ“¥ åŒ¯å…¥å­¸ç”Ÿè³‡æ–™
                        <span class="function-status status-checking"></span>
                        <span class="function-tooltip">éœ€æª¢æŸ¥å¾Œç«¯æ”¯æ´</span>
                    </button>
                    <button class="action-button button-with-status" onclick="exportStudentData()" data-function="exportStudentData">
                        ğŸ“¤ åŒ¯å‡ºå­¸ç”Ÿè³‡æ–™
                        <span class="function-status status-checking"></span>
                        <span class="function-tooltip">éœ€æª¢æŸ¥å¾Œç«¯æ”¯æ´</span>
                    </button>
                </div>
            </div>
            
            <!-- 4. ç›£æ§èˆ‡å ±å‘Š (å®šæœŸæª¢æŸ¥) -->
            <div class="section">
                <h2>ğŸ“Š ç›£æ§èˆ‡å ±å‘Š</h2>
                <p class="section-description">å®šæœŸæª¢æŸ¥ç³»çµ±ç‹€æ…‹å’Œç”Ÿæˆå ±å‘Š</p>
                <div class="button-grid">
                    <button class="action-button secondary" onclick="checkAllProgress()">
                        ğŸ“Š æª¢æŸ¥å…¨é«”é€²åº¦
                    </button>
                    <button class="action-button secondary" onclick="generateProgressReport()">
                        ğŸ“ˆ ç”Ÿæˆé€²åº¦å ±å‘Š
                    </button>
                    <button class="action-button" onclick="updateTeachersList()">
                        ğŸ”„ æ›´æ–°è€å¸«åˆ—è¡¨
                    </button>
                    <button class="action-button secondary" onclick="executeSystemTest()">
                        ğŸ§ª åŸ·è¡Œç³»çµ±æ¸¬è©¦
                    </button>
                </div>
            </div>
            
            <!-- 5. ç³»çµ±ç®¡ç† (é€²éšåŠŸèƒ½) -->
            <div class="section">
                <h2>âš™ï¸ ç³»çµ±ç®¡ç†</h2>
                <p class="section-description">é€²éšç³»çµ±ç®¡ç†å’Œç¶­è­·åŠŸèƒ½</p>
                <div class="button-grid">
                    <button class="action-button secondary" onclick="showSystemSettings()">
                        âš™ï¸ ç³»çµ±è¨­å®š
                    </button>
                    <button class="action-button secondary" onclick="openSystemFolder()">
                        ğŸ“ é–‹å•Ÿç³»çµ±è³‡æ–™å¤¾
                    </button>
                    <button class="action-button" onclick="setupAutomation()">
                        ğŸ”„ è¨­å®šè‡ªå‹•åŒ–
                    </button>
                    <button class="action-button" onclick="performBackup()">
                        ğŸ’¾ æ‰‹å‹•å‚™ä»½
                    </button>
                    <button class="action-button secondary" onclick="checkFileIntegrity()">
                        ğŸ” æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§
                    </button>
                </div>
            </div>
            
            <!-- 3. å­¸ç”Ÿç•°å‹•ç®¡ç† (å­¸ç”Ÿè³‡æ–™ç¶­è­·) -->
            <div class="section">
                <h2>ğŸ”„ å­¸ç”Ÿç•°å‹•ç®¡ç†</h2>
                <p class="section-description">å­¸ç”Ÿè½‰å­¸ã€è½‰ç­åŠè³‡æ–™æ›´æ–°ç®¡ç†</p>
                
                <!-- å­¸ç”Ÿæœå°‹å™¨ -->
                <div class="student-search-container">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="studentSearchInput">ğŸ” å­¸ç”Ÿæœå°‹ï¼š</label>
                            <input type="text" id="studentSearchInput" placeholder="è¼¸å…¥å­¸ç”ŸIDæˆ–å§“å..." />
                            <button class="search-button" onclick="searchStudent()">æœå°‹</button>
                        </div>
                    </div>
                    
                    <div id="studentSearchResults" class="search-results">
                        <!-- æœå°‹çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                </div>
                
                <!-- ç•°å‹•æ“ä½œå€ -->
                <div class="change-operations">
                    <h3>ğŸ“‹ ç•°å‹•æ“ä½œ</h3>
                    <div class="button-grid">
                        <button class="action-button danger" onclick="showTransferOutForm()">
                            ğŸ“¤ å­¸ç”Ÿè½‰å­¸/ç§»å‡º
                        </button>
                        <button class="action-button warning" onclick="showClassChangeForm()">
                            ğŸ”„ å­¸ç”Ÿè½‰ç­
                        </button>
                        <button class="action-button secondary" onclick="showInfoUpdateForm()">
                            âœï¸ å­¸ç”Ÿè³‡æ–™æ›´æ–°
                        </button>
                    </div>
                </div>
                
                <!-- ç•°å‹•è¨˜éŒ„æŸ¥çœ‹ -->
                <div class="change-history">
                    <h3>ğŸ“‹ ç•°å‹•è¨˜éŒ„</h3>
                    <div class="button-grid">
                        <button class="action-button secondary" onclick="viewChangeHistory()">
                            ğŸ“‹ æŸ¥çœ‹ç•°å‹•è¨˜éŒ„
                        </button>
                        <button class="action-button secondary" onclick="generateChangeReport()">
                            ğŸ“Š ç•°å‹•çµ±è¨ˆå ±å‘Š
                        </button>
                        <button class="action-button warning" onclick="showRollbackForm()">
                            â†©ï¸ ç•°å‹•å›æ»¾
                        </button>
                    </div>
                </div>
                
                <div class="instructions" style="margin-top: 20px;">
                    <h3>ğŸ“š ä½¿ç”¨èªªæ˜ï¼š</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6;">
                        <p><strong>ğŸ”„ ç•°å‹•æ“ä½œï¼š</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>å­¸ç”Ÿè½‰å­¸/ç§»å‡ºï¼š</strong>å®Œå…¨ç§»é™¤å­¸ç”Ÿçš„æ‰€æœ‰é›»è¯è¨˜éŒ„</li>
                            <li><strong>å­¸ç”Ÿè½‰ç­ï¼š</strong>å°‡å­¸ç”Ÿå¾åŸè€å¸«è½‰ç§»åˆ°æ–°è€å¸«è¨˜éŒ„ç°¿</li>
                            <li><strong>å­¸ç”Ÿè³‡æ–™æ›´æ–°ï¼š</strong>æ›´æ–°å­¸ç”Ÿå€‹äººè³‡è¨Šä¸¦åŒæ­¥åˆ°æ‰€æœ‰ç›¸é—œè¨˜éŒ„</li>
                            <li><strong>ç•°å‹•å›æ»¾ï¼š</strong>æ¢å¾©ç•°å‹•å‰çš„è³‡æ–™ç‹€æ…‹</li>
                        </ul>
                        <p style="color: #666; font-style: italic; margin-top: 10px;">
                            âš ï¸ æ³¨æ„ï¼šæ‰€æœ‰ç•°å‹•æ“ä½œéƒ½æœƒè‡ªå‹•å‚™ä»½åŸå§‹è³‡æ–™ï¼Œæ”¯æ´å›æ»¾åŠŸèƒ½ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ç³»çµ±ç‹€æ…‹é¡¯ç¤ºå€ -->
            <div id="systemStatusIndicator" style="margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                    <h3 style="color: #495057; margin-bottom: 10px;">ğŸ”„ æª¢æŸ¥ç³»çµ±ç‹€æ…‹ä¸­...</h3>
                    <p style="color: #6c757d; margin: 0;">æ­£åœ¨æª¢æŸ¥ç³»çµ±åˆå§‹åŒ–ç‹€æ…‹ï¼Œè«‹ç¨å€™...</p>
                </div>
            </div>
            
            <!-- å¿«é€Ÿè¨­å®šå€ - å‹•æ…‹ç”Ÿæˆ -->
            <div id="quickSetupSection" style="display: none; margin-bottom: 20px;">
                <!-- å…§å®¹ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="section">
                <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
                <div class="instructions">
                    <h3>å¿«é€Ÿé–‹å§‹æŒ‡å—ï¼ˆæŒ‰åŸ·è¡Œæµç¨‹æ’åˆ—ï¼‰ï¼š</h3>
                    <ol>
                        <li><strong>ğŸš€ ç³»çµ±åˆå§‹åŒ–ï¼š</strong>é¦–æ¬¡ä½¿ç”¨è«‹å…ˆã€Œåˆå§‹åŒ–ç³»çµ±ã€ä¸¦ã€Œæª¢æŸ¥ç³»çµ±ç‹€æ…‹ã€</li>
                        <li><strong>ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½ï¼š</strong>æº–å‚™å­¸ç”Ÿç¸½è¡¨ï¼ˆåŒ…å« LT æ¬„ä½ï¼‰ï¼Œä½¿ç”¨ã€Œå¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿ã€</li>
                        <li><strong>ğŸ”„ å­¸ç”Ÿç•°å‹•ï¼š</strong>å¦‚éœ€å­¸ç”Ÿè½‰å­¸ã€è½‰ç­æˆ–è³‡æ–™æ›´æ–°ï¼Œä½¿ç”¨å­¸ç”Ÿç•°å‹•ç®¡ç†åŠŸèƒ½</li>
                        <li><strong>ğŸ“Š å®šæœŸç›£æ§ï¼š</strong>å®šæœŸä½¿ç”¨ã€Œæª¢æŸ¥å…¨é«”é€²åº¦ã€å’Œã€Œç”Ÿæˆé€²åº¦å ±å‘Šã€äº†è§£é›»è¯ç‹€æ³</li>
                        <li><strong>âš™ï¸ ç³»çµ±ç¶­è­·ï¼š</strong>ä½¿ç”¨ç³»çµ±ç®¡ç†åŠŸèƒ½é€²è¡Œå‚™ä»½ã€è¨­å®šå’Œç¶­è­·</li>
                    </ol>
                    
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #0066cc; margin: 0 0 10px 0;">ğŸ’¡ åŠŸèƒ½ç‹€æ…‹èªªæ˜ï¼š</h4>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <span style="color: #28a745;">âœ… å¯ç”¨åŠŸèƒ½</span> | 
                            <span style="color: #ffc107;">âš ï¸ éœ€æª¢æŸ¥åŠŸèƒ½</span> | 
                            <span style="color: #dc3545;">âŒ ä¸å¯ç”¨åŠŸèƒ½</span>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px; color: #666;">
                            ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬å„åŠŸèƒ½çš„å¾Œç«¯æ”¯æ´ç‹€æ…‹ï¼Œä¸¦åœ¨æŒ‰éˆ•ä¸Šé¡¯ç¤ºå°æ‡‰æ¨™ç¤ºã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2024 é›»è¯è¨˜éŒ„ç°¿ç³»çµ± - å°ˆç‚ºä¸­å¸«è‹±æ–‡ç§‘è¨­è¨ˆ</p>
        </div>
    </div>

    <!-- å­¸ç”Ÿç•°å‹•ç®¡ç†æ¨¡æ…‹æ¡† -->
    
    <!-- å­¸ç”Ÿè½‰å­¸/ç§»å‡ºæ¨¡æ…‹æ¡† -->
    <div id="transferOutModal" class="change-modal">
        <div class="change-modal-content">
            <div class="change-modal-header">
                <h3>ğŸ“¤ å­¸ç”Ÿè½‰å­¸/ç§»å‡º</h3>
                <span class="change-modal-close">&times;</span>
            </div>
            <div class="change-form">
                <div class="form-group">
                    <label for="transferOutStudentId">å­¸ç”ŸIDï¼š</label>
                    <input type="text" id="transferOutStudentId" placeholder="è«‹è¼¸å…¥å­¸ç”ŸID" />
                </div>
                <div class="form-group">
                    <label for="transferOutReason">è½‰å­¸åŸå› ï¼š</label>
                    <textarea id="transferOutReason" placeholder="è«‹è¼¸å…¥è½‰å­¸/ç§»å‡ºåŸå› "></textarea>
                </div>
                <div class="change-form-actions">
                    <button class="btn-secondary" onclick="closeTransferOutModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="processTransferOut()">ç¢ºèªè½‰å­¸</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­¸ç”Ÿè½‰ç­æ¨¡æ…‹æ¡† -->
    <div id="classChangeModal" class="change-modal">
        <div class="change-modal-content">
            <div class="change-modal-header">
                <h3>ğŸ”„ å­¸ç”Ÿè½‰ç­</h3>
                <span class="change-modal-close">&times;</span>
            </div>
            <div class="change-form">
                <div class="form-group">
                    <label for="classChangeStudentId">å­¸ç”ŸIDï¼š</label>
                    <input type="text" id="classChangeStudentId" placeholder="è«‹è¼¸å…¥å­¸ç”ŸID" />
                </div>
                <div class="form-group">
                    <label for="classChangeNewClass">ç›®æ¨™ç­ç´šï¼š</label>
                    <select id="classChangeNewClass" onchange="onClassSelected()">
                        <option value="">è«‹é¸æ“‡ç­ç´š...</option>
                    </select>
                    <div id="selectedClassInfo" class="class-info-display"></div>
                </div>
                <div class="change-form-actions">
                    <button class="btn-secondary" onclick="closeClassChangeModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="processClassChange()">ç¢ºèªè½‰ç­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­¸ç”Ÿè³‡æ–™æ›´æ–°æ¨¡æ…‹æ¡† -->
    <div id="infoUpdateModal" class="change-modal">
        <div class="change-modal-content">
            <div class="change-modal-header">
                <h3>âœï¸ å­¸ç”Ÿè³‡æ–™æ›´æ–°</h3>
                <span class="change-modal-close">&times;</span>
            </div>
            <div class="change-form">
                <div class="form-group">
                    <label for="infoUpdateStudentId">å­¸ç”ŸIDï¼š</label>
                    <input type="text" id="infoUpdateStudentId" placeholder="è«‹è¼¸å…¥å­¸ç”ŸID" />
                </div>
                <div class="form-group">
                    <label for="infoUpdateField">æ›´æ–°æ¬„ä½ï¼š</label>
                    <select id="infoUpdateField">
                        <option value="Chinese Name">ä¸­æ–‡å§“å</option>
                        <option value="English Name">è‹±æ–‡å§“å</option>
                        <option value="English Class">è‹±æ–‡ç­ç´š</option>
                        <option value="Mother's Phone">æ¯è¦ªé›»è©±</option>
                        <option value="Father's Phone">çˆ¶è¦ªé›»è©±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="infoUpdateValue">æ–°å€¼ï¼š</label>
                    <input type="text" id="infoUpdateValue" placeholder="è«‹è¼¸å…¥æ–°å€¼" />
                </div>
                <div class="change-form-actions">
                    <button class="btn-secondary" onclick="closeInfoUpdateModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="processInfoUpdate()">ç¢ºèªæ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç•°å‹•å›æ»¾æ¨¡æ…‹æ¡† -->
    <div id="rollbackModal" class="change-modal">
        <div class="change-modal-content">
            <div class="change-modal-header">
                <h3>â†©ï¸ ç•°å‹•å›æ»¾</h3>
                <span class="change-modal-close">&times;</span>
            </div>
            <div class="change-form">
                <div class="form-group">
                    <label for="rollbackChangeId">ç•°å‹•IDï¼š</label>
                    <input type="text" id="rollbackChangeId" placeholder="è«‹è¼¸å…¥ç•°å‹•ID" />
                </div>
                <div class="change-form-actions">
                    <button class="btn-secondary" onclick="closeRollbackModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="processRollback()">ç¢ºèªå›æ»¾</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿç¸½è¡¨åŒ¯å…¥æ¨¡æ…‹æ¡† -->
    <div id="masterListModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ğŸ“‹ å¾å­¸ç”Ÿç¸½è¡¨å»ºç«‹è€å¸«è¨˜éŒ„ç°¿</h2>
            
            <!-- é¸é …é¸æ“‡ -->
            <div class="form-group">
                <label>è«‹é¸æ“‡å­¸ç”Ÿç¸½è¡¨ä¾†æºï¼š</label>
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="radio" name="masterListSource" value="system" checked style="margin-right: 8px;">
                        ğŸ”¥ ä½¿ç”¨ç³»çµ±å­¸ç”Ÿç¸½è¡¨ï¼ˆæ¨è–¦ï¼‰
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        ä½¿ç”¨åˆå§‹åŒ–æ™‚å‰µå»ºçš„å­¸ç”Ÿç¸½è¡¨ï¼Œç„¡éœ€è¼¸å…¥ ID
                    </small>
                    
                    <label style="display: block; margin-top: 12px;">
                        <input type="radio" name="masterListSource" value="custom" style="margin-right: 8px;">
                        ğŸ“‹ ä½¿ç”¨è‡ªè¨‚å­¸ç”Ÿç¸½è¡¨
                    </label>
                    <small style="color: #666; margin-left: 24px; display: block;">
                        ä½¿ç”¨å…¶ä»– Google Sheets æª”æ¡ˆä½œç‚ºå­¸ç”Ÿç¸½è¡¨
                    </small>
                </div>
            </div>
            
            <!-- è‡ªè¨‚ ID è¼¸å…¥å€åŸŸ -->
            <div id="customIdSection" class="form-group" style="display: none;">
                <label for="masterListId">å­¸ç”Ÿç¸½è¡¨ Google Sheets IDï¼š</label>
                <input type="text" id="masterListId" placeholder="è«‹è¼¸å…¥ Google Sheets çš„å®Œæ•´ ID">
                <small style="color: #666; display: block; margin-top: 5px;">
                    ç¯„ä¾‹ï¼šå¾ https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit ä¸­è¤‡è£½ 1ABC...XYZ éƒ¨åˆ†
                </small>
            </div>
            
            <div class="form-group">
                <label>ç³»çµ±è¦æ±‚ï¼š</label>
                <ul style="padding-left: 20px; color: #666;">
                    <li>å­¸ç”Ÿç¸½è¡¨å¿…é ˆåŒ…å« LT (Local Teacher) æ¬„ä½</li>
                    <li>åŒ…å« English Class æ¬„ä½ç”¨æ–¼ç­ç´šè³‡è¨Š</li>
                    <li>åŒ…å«å­¸ç”ŸåŸºæœ¬è³‡æ–™æ¬„ä½</li>
                </ul>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="processMasterList()" style="margin-right: 10px;">
                    é–‹å§‹è™•ç†
                </button>
                <button class="action-button secondary" onclick="closeMasterListModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è€å¸«æ¨¡æ…‹æ¡† -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ğŸ‘¨â€ğŸ« æ–°å¢è€å¸«è¨˜éŒ„ç°¿</h2>
            <div class="form-group">
                <label for="teacherName">è€å¸«å§“åï¼š</label>
                <input type="text" id="teacherName" placeholder="è«‹è¼¸å…¥è€å¸«å§“å">
            </div>
            <div class="form-group">
                <label for="teacherClasses">æˆèª²ç­ç´šï¼š</label>
                <input type="text" id="teacherClasses" placeholder="ä¾‹å¦‚ï¼š701,702,703ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="action-button" onclick="createSingleTeacher()" style="margin-right: 10px;">
                    å»ºç«‹è¨˜éŒ„ç°¿
                </button>
                <button class="action-button secondary" onclick="closeTeacherModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>


    <script>
        'use strict';
        
        // ===== APPLICATION CONSTANTS =====
        const APP_CONFIG = {
            name: 'é›»è¯è¨˜éŒ„ç°¿ç³»çµ±',
            version: '2.0.0',
            environment: 'production',
            debug: false
        };
        
        // ===== SYSTEM CONFIGURATION =====
        const SYSTEM_CONFIG = {
            // MAIN_FOLDER_ID å°‡å¾å¾Œç«¯å‹•æ…‹ç²å–ï¼Œä¸éœ€è¦ç¡¬ç·¨ç¢¼
            // ç›´æ¥ä½¿ç”¨ google.script.run èª¿ç”¨å¾Œç«¯å‡½æ•¸
        };
        
        // ===== UTILITY MODULES =====
        const Utils = {
            // DOMæ“ä½œå·¥å…·
            dom: {
                $(selector) {
                    return document.querySelector(selector);
                },
                $$(selector) {
                    return document.querySelectorAll(selector);
                },
                show(element) {
                    if (typeof element === 'string') element = this.$(element);
                    if (element) element.style.display = 'block';
                },
                hide(element) {
                    if (typeof element === 'string') element = this.$(element);
                    if (element) element.style.display = 'none';
                },
                addClass(element, className) {
                    if (typeof element === 'string') element = this.$(element);
                    if (element) element.classList.add(className);
                },
                removeClass(element, className) {
                    if (typeof element === 'string') element = this.$(element);
                    if (element) element.classList.remove(className);
                }
            },
            
            // è¼‰å…¥ç‹€æ…‹ç®¡ç†
            loading: {
                show(message = 'è¼‰å…¥ä¸­...') {
                    Utils.dom.show('#loadingOverlay');
                    const loadingText = Utils.dom.$('.loading-text');
                    if (loadingText) loadingText.textContent = message;
                },
                hide() {
                    Utils.dom.hide('#loadingOverlay');
                }
            },
            
            // é€šçŸ¥ç³»çµ±
            notify: {
                success(title, message) {
                    const popup = Utils.dom.$('.success-popup');
                    if (popup) {
                        Utils.dom.$('.success-popup h3').textContent = title;
                        Utils.dom.$('.success-popup p').textContent = message;
                        Utils.dom.show(popup);
                    }
                },
                error(title, message) {
                    const popup = Utils.dom.$('.error-popup');
                    if (popup) {
                        Utils.dom.$('.error-popup h3').textContent = title;
                        Utils.dom.$('.error-popup p').textContent = message;
                        Utils.dom.show(popup);
                    }
                }
            },
            
            // APIèª¿ç”¨åŒ…è£å™¨
            api: {
                async call(functionName, ...args) {
                    return new Promise((resolve, reject) => {
                        try {
                            // è¨­ç½®è¶…æ™‚è™•ç†
                            const timeoutId = setTimeout(() => {
                                reject(new Error(`APIèª¿ç”¨è¶…æ™‚: ${functionName} (30ç§’)`));
                            }, 30000); // 30ç§’è¶…æ™‚
                            
                            // å¢å¼·æˆåŠŸè™•ç†å™¨
                            const enhancedSuccessHandler = (result) => {
                                clearTimeout(timeoutId);
                                
                                // æª¢æŸ¥çµæœæ˜¯å¦ç‚ºnullæˆ–undefined
                                if (result === null || result === undefined) {
                                    console.warn(`API ${functionName} returned null/undefined`);
                                    resolve({
                                        success: false,
                                        message: 'APIè¿”å›ç©ºå€¼',
                                        error: 'NULL_RESPONSE'
                                    });
                                    return;
                                }
                                
                                resolve(result);
                            };
                            
                            // å¢å¼·å¤±æ•—è™•ç†å™¨
                            const enhancedFailureHandler = (error) => {
                                clearTimeout(timeoutId);
                                console.error(`API ${functionName} failed:`, error);
                                
                                // æ¨™æº–åŒ–éŒ¯èª¤æ ¼å¼
                                const standardError = {
                                    success: false,
                                    message: error?.message || 'æœªçŸ¥éŒ¯èª¤',
                                    error: error?.toString() || 'UNKNOWN_ERROR',
                                    functionName: functionName
                                };
                                
                                reject(standardError);
                            };
                            
                            // åŸ·è¡ŒGoogle Apps Scriptèª¿ç”¨
                            google.script.run
                                .withSuccessHandler(enhancedSuccessHandler)
                                .withFailureHandler(enhancedFailureHandler)
                                [functionName](...args);
                                
                        } catch (error) {
                            console.error(`API call setup failed for ${functionName}:`, error);
                            reject({
                                success: false,
                                message: `APIèª¿ç”¨è¨­ç½®å¤±æ•—: ${error.message}`,
                                error: error.toString(),
                                functionName: functionName
                            });
                        }
                    });
                }
            }
        };
        
        // ===== MODAL MANAGEMENT MODULE =====
        const ModalManager = {
            modals: new Map(),
            
            register(modalId, modal) {
                this.modals.set(modalId, modal);
            },
            
            show(modalId) {
                const element = Utils.dom.$(`#${modalId}`);
                if (element) {
                    Utils.dom.show(element);
                    document.body.style.overflow = 'hidden';
                }
            },
            
            hide(modalId) {
                const element = Utils.dom.$(`#${modalId}`);
                if (element) {
                    Utils.dom.hide(element);
                    document.body.style.overflow = 'auto';
                }
            },
            
            hideAll() {
                this.modals.forEach((modal, id) => {
                    this.hide(id);
                });
            }
        };
        
        // ===== STATE MANAGEMENT MODULE =====
        const StateManager = {
            state: {
                systemStatus: null,
                currentSemester: 'Fall',
                currentTerm: 'Beginning',
                systemStats: {}
            },
            
            setState(key, value) {
                this.state[key] = value;
                this.notifySubscribers(key, value);
            },
            
            getState(key) {
                return this.state[key];
            },
            
            subscribers: new Map(),
            
            subscribe(key, callback) {
                if (!this.subscribers.has(key)) {
                    this.subscribers.set(key, []);
                }
                this.subscribers.get(key).push(callback);
            },
            
            notifySubscribers(key, value) {
                if (this.subscribers.has(key)) {
                    this.subscribers.get(key).forEach(callback => {
                        try {
                            callback(value);
                        } catch (error) {
                            console.error('StateManager callback error:', error);
                        }
                    });
                }
            }
        };

        // ===== LEGACY FUNCTION WRAPPERS =====
        // æ¨¡æ…‹æ¡†æ§åˆ¶ - ä½¿ç”¨æ–°çš„ ModalManager
        function showMasterListModal() {
            ModalManager.show('masterListModal');
        }

        function closeMasterListModal() {
            ModalManager.hide('masterListModal');
        }

        function showTeacherModal() {
            ModalManager.show('teacherModal');
        }

        function closeTeacherModal() {
            ModalManager.hide('teacherModal');
        }

        // ===== APPLICATION INITIALIZATION =====
        const App = {
            async init() {
                console.log(`${APP_CONFIG.name} v${APP_CONFIG.version} initializing...`);
                
                try {
                    // 1. è¨»å†Šæ¨¡æ…‹æ¡†
                    Utils.loading.show('ğŸ”§ æº–å‚™ç³»çµ±ä»‹é¢...');
                    this.registerModals();
                    
                    // 2. è¨­ç½®äº‹ä»¶ç›£è½å™¨
                    Utils.loading.show('âš™ï¸ è¨­ç½®äº’å‹•åŠŸèƒ½...');
                    this.setupEventListeners();
                    
                    // 3. åˆå§‹åŒ–ç³»çµ±ç‹€æ…‹ (ç§»é™¤è‡ªå‹•ç³»çµ±ç‹€æ…‹æª¢æŸ¥ï¼Œé¿å…è¼‰å…¥å¡ä½)
                    Utils.loading.show('ğŸ“‹ åˆå§‹åŒ–ç³»çµ±è¨­å®š...');
                    await this.initializeSystemState();
                    
                    // 4. è¼‰å…¥ç³»çµ±çµ±è¨ˆ (è¨­ç½®é è¨­å€¼ï¼Œä¸èª¿ç”¨å¾Œç«¯)
                    Utils.loading.show('ğŸ“Š è¨­ç½®é è¨­çµ±è¨ˆ...');
                    this.setDefaultStatsDisplay();
                    
                    // 5. åˆå§‹åŒ–å®Œæˆ
                    Utils.loading.show('âœ… åˆå§‹åŒ–å®Œæˆ...');
                    StateManager.setState('appInitialized', true);
                    console.log('Application initialized successfully');
                    
                    // çŸ­æš«é¡¯ç¤ºå®Œæˆè¨Šæ¯å¾Œéš±è—è¼‰å…¥å‹•ç•«
                    setTimeout(() => {
                        Utils.loading.hide();
                    }, 800);
                    
                } catch (error) {
                    Utils.loading.hide();
                    console.error('Application initialization failed:', error);
                    Utils.notify.error('åˆå§‹åŒ–å¤±æ•—', 'æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
                    
                    // å³ä½¿åˆå§‹åŒ–å¤±æ•—ï¼Œä¹Ÿè¨­ç½®é è¨­ç‹€æ…‹é¿å…ç©ºç™½é é¢
                    this.setDefaultStatsDisplay();
                }
            },
            
            
            setDefaultStatsDisplay() {
                const defaultStats = {
                    teacherCount: 0,
                    studentCount: 0,
                    contactCount: 0,
                    semesterProgress: '0%',
                    currentSemester: 'Fall',
                    currentTerm: 'Beginning'
                };
                
                this.updateStatsDisplay(defaultStats);
                console.log('Default stats display set');
            },
            
            registerModals() {
                const modalIds = [
                    'masterListModal', 'teacherModal', 'transferOutModal', 
                    'classChangeModal', 'infoUpdateModal', 'rollbackModal'
                ];
                
                modalIds.forEach(id => {
                    const element = Utils.dom.$(`#${id}`);
                    if (element) {
                        ModalManager.register(id, element);
                    }
                });
            },
            
            setupEventListeners() {
                // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal')) {
                        ModalManager.hideAll();
                    }
                });
                
                // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        ModalManager.hideAll();
                    }
                });
                
                // ç•°å‹•ç®¡ç†æ¨¡æ…‹æ¡†é—œé–‰äº‹ä»¶
                document.querySelectorAll('.change-modal-close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', function() {
                        this.closest('.change-modal').style.display = 'none';
                    });
                });
                
                // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
                document.querySelectorAll('.change-modal').forEach(modal => {
                    modal.addEventListener('click', function(event) {
                        if (event.target === this) {
                            this.style.display = 'none';
                        }
                    });
                });
                
                // å­¸æœŸ/éšæ®µé¸æ“‡å™¨
                const semesterSelect = Utils.dom.$('#semesterSelect');
                const termSelect = Utils.dom.$('#termSelect');
                
                if (semesterSelect) {
                    semesterSelect.addEventListener('change', (e) => {
                        StateManager.setState('currentSemester', e.target.value);
                        this.updateSystemStats();
                    });
                }
                
                if (termSelect) {
                    termSelect.addEventListener('change', (e) => {
                        StateManager.setState('currentTerm', e.target.value);
                        this.updateSystemStats();
                    });
                }
                
                // è¨­å®šé¸æ“‡å™¨äº‹ä»¶ç›£è½
                const updateStatsBtn = document.getElementById('updateStatsBtn');
                if (updateStatsBtn) {
                    updateStatsBtn.addEventListener('click', function() {
                        const semester = document.getElementById('semesterSelect').value;
                        const term = document.getElementById('termSelect').value;
                        updateStatsByStage(semester, term);
                    });
                }
            },
            
            async initializeSystemState() {
                // è¨­ç½®é»˜èªç‹€æ…‹
                StateManager.setState('currentSemester', 'Fall');
                StateManager.setState('currentTerm', 'Beginning');
                
                // è¨‚é–±ç‹€æ…‹è®ŠåŒ–
                StateManager.subscribe('systemStats', (stats) => {
                    this.updateStatsDisplay(stats);
                });
            },
            
            async loadSystemStats() {
                try {
                    Utils.loading.show('ğŸ“Š è¼‰å…¥ç³»çµ±çµ±è¨ˆè³‡æ–™...');
                    
                    // èª¿ç”¨çµ±è¨ˆ API
                    const response = await Utils.api.call('getSystemStatsWeb');
                    
                    // æª¢æŸ¥éŸ¿æ‡‰æ˜¯å¦ç‚ºç©ºæˆ–ç„¡æ•ˆ
                    if (!response) {
                        console.error('Received null response from getSystemStatsWeb');
                        throw new Error('ç„¡æ³•ç²å–ç³»çµ±çµ±è¨ˆè³‡æ–™');
                    }
                    
                    // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼æ˜¯å¦æ­£ç¢º
                    if (typeof response !== 'object') {
                        console.error('Invalid response format from getSystemStatsWeb:', response);
                        throw new Error('ç³»çµ±çµ±è¨ˆè³‡æ–™æ ¼å¼ç•°å¸¸');
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–è³‡æ–™
                    if (response.success && response.stats) {
                        StateManager.setState('systemStats', response.stats);
                        this.updateStatsDisplay(response.stats);
                        
                        // è¨­å®šé è¨­é¸æ“‡å™¨å€¼
                        const semesterSelect = document.getElementById('semesterSelect');
                        const termSelect = document.getElementById('termSelect');
                        
                        if (semesterSelect && response.stats.currentSemester) {
                            semesterSelect.value = response.stats.currentSemester;
                        }
                        if (termSelect && response.stats.currentTerm) {
                            termSelect.value = response.stats.currentTerm;
                        }
                        
                        console.log('System stats loaded successfully');
                    } else {
                        console.error('Failed to get system stats:', response.message);
                        throw new Error(response.message || 'ç„¡æ³•ç²å–ç³»çµ±çµ±è¨ˆè³‡æ–™');
                    }
                } catch (error) {
                    console.error('Failed to load system stats:', error);
                    Utils.notify.error('è¼‰å…¥å¤±æ•—', error.message || 'çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢');
                    
                    // è¨­ç½®é è¨­çµ±è¨ˆè³‡æ–™
                    const defaultStats = {
                        teacherCount: 0,
                        studentCount: 0,
                        contactCount: 0,
                        semesterProgress: '0%',
                        currentSemester: 'Fall',
                        currentTerm: 'Beginning'
                    };
                    this.updateStatsDisplay(defaultStats);
                } finally {
                    Utils.loading.hide();
                }
            },
            
            async updateSystemStats() {
                const semester = StateManager.getState('currentSemester');
                const term = StateManager.getState('currentTerm');
                
                try {
                    const response = await Utils.api.call('getSystemStatsWeb', { semester, term });
                    
                    // æª¢æŸ¥éŸ¿æ‡‰æ˜¯å¦ç‚ºç©ºæˆ–ç„¡æ•ˆ
                    if (!response) {
                        console.error('Received null response from getSystemStatsWeb');
                        Utils.notify.error('ç³»çµ±éŒ¯èª¤', 'ç„¡æ³•ç²å–ç³»çµ±çµ±è¨ˆè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');
                        return;
                    }
                    
                    // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼æ˜¯å¦æ­£ç¢º
                    if (typeof response !== 'object') {
                        console.error('Invalid response format from getSystemStatsWeb:', response);
                        Utils.notify.error('è³‡æ–™æ ¼å¼éŒ¯èª¤', 'ç³»çµ±çµ±è¨ˆè³‡æ–™æ ¼å¼ç•°å¸¸');
                        return;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–è³‡æ–™
                    if (response.success) {
                        StateManager.setState('systemStats', response.stats);
                    } else {
                        console.error('Failed to get system stats:', response.message);
                        Utils.notify.error('ç²å–å¤±æ•—', response.message || 'ç„¡æ³•ç²å–ç³»çµ±çµ±è¨ˆè³‡æ–™');
                    }
                } catch (error) {
                    console.error('Failed to update system stats:', error);
                    Utils.notify.error('ç³»çµ±éŒ¯èª¤', 'çµ±è¨ˆè³‡æ–™æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            },
            
            updateStatsDisplay(stats) {
                // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
                const elements = {
                    teacherCount: Utils.dom.$('#teacherCount'),
                    studentCount: Utils.dom.$('#studentCount'),
                    contactCount: Utils.dom.$('#contactCount'),
                    progressRate: Utils.dom.$('#progressRate')
                };
                
                if (stats && typeof stats === 'object') {
                    // è™•ç†ä¸€èˆ¬çµ±è¨ˆæ•¸æ“š
                    Object.entries(elements).forEach(([key, element]) => {
                        if (element) {
                            let value = stats[key];
                            
                            // ç‰¹æ®Šè™•ç†é€²åº¦ç™¾åˆ†æ¯”
                            if (key === 'progressRate' && stats.semesterProgress !== undefined) {
                                value = stats.semesterProgress;
                            }
                            
                            // ç¢ºä¿æœ‰å€¼ä¸”ä¸ç‚º undefined
                            if (value !== undefined && value !== null) {
                                element.textContent = value;
                            } else {
                                element.textContent = key === 'progressRate' ? '0%' : '0';
                            }
                        }
                    });
                    
                    console.log('Stats display updated:', stats);
                } else {
                    // è¨­ç½®é è¨­å€¼
                    Object.entries(elements).forEach(([key, element]) => {
                        if (element) {
                            element.textContent = key === 'progressRate' ? '0%' : '0';
                        }
                    });
                    console.log('Stats display set to default values');
                }
            }
        };
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰ (Legacy support)
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // é—œé–‰æŒ‰éˆ•äº‹ä»¶
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                this.closest('.modal').style.display = 'none';
            }
        });

        // è™•ç†å­¸ç”Ÿç¸½è¡¨ä¾†æºé¸æ“‡
        document.addEventListener('change', function(e) {
            if (e.target.name === 'masterListSource') {
                const customSection = document.getElementById('customIdSection');
                if (e.target.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            }
        });

        // ä¸»è¦åŠŸèƒ½å‡½æ•¸
        function processMasterList() {
            const sourceType = document.querySelector('input[name="masterListSource"]:checked').value;
            let sheetId = '';
            
            if (sourceType === 'custom') {
                sheetId = document.getElementById('masterListId').value.trim();
                if (!sheetId) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿç¸½è¡¨çš„ Google Sheets ID');
                    return;
                }
            }
            // å¦‚æœæ˜¯ systemï¼ŒsheetId ä¿æŒç©ºå­—ä¸²ï¼Œå¾Œç«¯æœƒè‡ªå‹•ä½¿ç”¨ç³»çµ±å­¸ç”Ÿç¸½è¡¨
            
            // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è™•ç†ä¸­...';
            button.disabled = true;
            
            // èª¿ç”¨å®Œæ•´çš„ Web ç‰ˆæœ¬åŠŸèƒ½
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeMasterListModal();
                    
                    // æª¢æŸ¥çµæœæ˜¯å¦ç‚ºç©º
                    if (!result) {
                        console.error('processMasterList received null result');
                        alert('âŒ ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•ç²å–è™•ç†çµæœï¼Œè«‹ç¨å¾Œå†è©¦');
                        return;
                    }
                    
                    // æª¢æŸ¥çµæœæ ¼å¼
                    if (typeof result !== 'object') {
                        console.error('processMasterList received invalid result format:', result);
                        alert('âŒ ç³»çµ±éŒ¯èª¤ï¼šè¿”å›è³‡æ–™æ ¼å¼ç•°å¸¸');
                        return;
                    }
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                        if (result.results && result.results.successCount > 0) {
                            updateStats(); // æ›´æ–°çµ±è¨ˆè³‡æ–™
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .createTeachersFromStudentMasterListWeb(sheetId);
        }

        function createSingleTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const classes = document.getElementById('teacherClasses').value.trim();
            
            if (!name || !classes) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„è€å¸«è³‡è¨Š');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'å»ºç«‹ä¸­...';
            button.disabled = true;
            
            // æº–å‚™è³‡æ–™
            const formData = {
                action: 'createSingleTeacher',
                teacherName: name,
                teacherClasses: classes
            };
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    closeTeacherModal();
                    
                    // æª¢æŸ¥çµæœæ˜¯å¦ç‚ºç©º
                    if (!result) {
                        console.error('createSingleTeacher received null result');
                        alert('âŒ ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•ç²å–å»ºç«‹çµæœï¼Œè«‹ç¨å¾Œå†è©¦');
                        return;
                    }
                    
                    // æª¢æŸ¥çµæœæ ¼å¼
                    if (typeof result !== 'object') {
                        console.error('createSingleTeacher received invalid result format:', result);
                        alert('âŒ ç³»çµ±éŒ¯èª¤ï¼šè¿”å›è³‡æ–™æ ¼å¼ç•°å¸¸');
                        return;
                    }
                    
                    if (result.success) {
                        alert('è€å¸«è¨˜éŒ„ç°¿å»ºç«‹æˆåŠŸï¼\n' + result.message);
                        if (result.recordBookUrl) {
                            if (confirm('æ˜¯å¦è¦é–‹å•Ÿæ–°å»ºç«‹çš„è¨˜éŒ„ç°¿ï¼Ÿ')) {
                                window.open(result.recordBookUrl, '_blank');
                            }
                        }
                    } else {
                        alert('å»ºç«‹å¤±æ•—ï¼š' + result.message);
                    }
                    updateStats();
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('å»ºç«‹å¤±æ•—ï¼š' + error.message);
                })
                .createSingleTeacherWeb(formData);
        }


        function openSystemFolder() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                    } else {
                        alert('ç„¡æ³•é–‹å•Ÿç³»çµ±è³‡æ–™å¤¾ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('é–‹å•Ÿè³‡æ–™å¤¾å¤±æ•—ï¼š' + error.message);
                })
                .getSystemFolderUrl();
        }

        function importStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'åŒ¯å…¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                        updateStats();
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('importStudentData');
        }

        function exportStudentData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'åŒ¯å‡ºä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = 'âœ… ' + result.message;
                        if (result.exportUrl) {
                            if (confirm(message + '\n\næ˜¯å¦è¦é–‹å•ŸåŒ¯å‡ºæª”æ¡ˆï¼Ÿ')) {
                                window.open(result.exportUrl, '_blank');
                            }
                        } else {
                            alert(message);
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('exportStudentData');
        }

        function updateTeachersList() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('è€å¸«åˆ—è¡¨æ›´æ–°å®Œæˆï¼');
                        updateStats();
                    } else {
                        alert('æ›´æ–°å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('updateTeachersList');
        }

        // ============ å­¸ç”Ÿç•°å‹•ç®¡ç† JavaScript å‡½æ•¸ ============
        
        // è¼‰å…¥å‹•ç•«å’Œæç¤ºæ§åˆ¶å‡½æ•¸
        function showLoading(message = 'è™•ç†ä¸­...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successPopup').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorPopup').style.display = 'block';
        }
        
        function closeSuccessPopup() {
            document.getElementById('successPopup').style.display = 'none';
        }
        
        function closeErrorPopup() {
            document.getElementById('errorPopup').style.display = 'none';
        }
        
        function searchStudent() {
            const searchInput = document.getElementById('studentSearchInput');
            const searchResults = document.getElementById('studentSearchResults');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('è«‹è¼¸å…¥å­¸ç”ŸIDæˆ–å§“å');
                return;
            }
            
            searchResults.innerHTML = 'ğŸ” æœå°‹ä¸­...';
            searchResults.classList.add('show');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.students.length > 0) {
                        displaySearchResults(result.students);
                    } else {
                        searchResults.innerHTML = 'ğŸ˜ æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿ';
                    }
                })
                .withFailureHandler(function(error) {
                    searchResults.innerHTML = 'âŒ æœå°‹å¤±æ•—ï¼š' + error.message;
                })
                .searchStudentWeb(searchTerm);
        }
        
        function displaySearchResults(students) {
            const searchResults = document.getElementById('studentSearchResults');
            let html = '<h4>ğŸ” æœå°‹çµæœï¼š</h4>';
            
            students.forEach(student => {
                html += `
                    <div class="student-card">
                        <h4>${student.student['Chinese Name'] || student.student['English Name'] || 'æœªçŸ¥'}</h4>
                        <div class="student-info">
                            <div><strong>ID:</strong> ${student.student.ID || student.student['Student ID']}</div>
                            <div><strong>ä¸­æ–‡å§“å:</strong> ${student.student['Chinese Name'] || 'æœªå¡«å¯«'}</div>
                            <div><strong>è‹±æ–‡å§“å:</strong> ${student.student['English Name'] || 'æœªå¡«å¯«'}</div>
                            <div><strong>è‹±æ–‡ç­ç´š:</strong> ${student.student['English Class'] || 'æœªå¡«å¯«'}</div>
                            <div><strong>å¹´ç´š:</strong> ${student.student.Grade || 'æœªå¡«å¯«'}</div>
                            <div><strong>ç­ç´š:</strong> ${student.student.HR || 'æœªå¡«å¯«'}</div>
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
        }
        
        function showTransferOutForm() {
            document.getElementById('transferOutModal').style.display = 'block';
        }
        
        function closeTransferOutModal() {
            document.getElementById('transferOutModal').style.display = 'none';
            document.getElementById('transferOutStudentId').value = '';
            document.getElementById('transferOutReason').value = '';
        }
        
        function processTransferOut() {
            const studentId = document.getElementById('transferOutStudentId').value.trim();
            const reason = document.getElementById('transferOutReason').value.trim();
            
            if (!studentId) {
                showError('è«‹è¼¸å…¥å­¸ç”ŸID');
                return;
            }
            
            if (!reason) {
                showError('è«‹è¼¸å…¥è½‰å­¸åŸå› ');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡å­¸ç”Ÿ ${studentId} è½‰å­¸/ç§»å‡ºå—ï¼Ÿ\n\nåŸå› ï¼š${reason}\n\næ­¤æ“ä½œç„¡æ³•ç›´æ¥å¾©åŸï¼Œä½†å¯ä»¥é€éç•°å‹•å›æ»¾åŠŸèƒ½æ¢å¾©ã€‚`)) {
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading('æ­£åœ¨è™•ç†å­¸ç”Ÿè½‰å­¸/ç§»å‡º...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showSuccess(`å­¸ç”Ÿè½‰å­¸è™•ç†å®Œæˆï¼\n\nç•°å‹•IDï¼š${result.changeId}\n\nè©³ç´°è³‡è¨Šï¼š\n- å­¸ç”ŸIDï¼š${studentId}\n- è½‰å­¸åŸå› ï¼š${reason}\n- è™•ç†æ™‚é–“ï¼š${new Date().toLocaleString()}`);
                        closeTransferOutModal();
                        updateStats();
                    } else {
                        showError('è½‰å­¸è™•ç†å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('è½‰å­¸è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processStudentTransferOutWeb(studentId, reason);
        }
        
        function showClassChangeForm() {
            document.getElementById('classChangeModal').style.display = 'block';
            loadAvailableClasses();
        }
        
        function closeClassChangeModal() {
            document.getElementById('classChangeModal').style.display = 'none';
            document.getElementById('classChangeStudentId').value = '';
            document.getElementById('classChangeNewClass').value = '';
            document.getElementById('selectedClassInfo').classList.remove('show');
        }
        
        function processClassChange() {
            const studentId = document.getElementById('classChangeStudentId').value.trim();
            const classSelect = document.getElementById('classChangeNewClass');
            const selectedClass = classSelect.value;
            
            if (!studentId) {
                showError('è«‹è¼¸å…¥å­¸ç”ŸID');
                return;
            }
            
            if (!selectedClass) {
                showError('è«‹é¸æ“‡ç›®æ¨™ç­ç´š');
                return;
            }
            
            // å¾é¸é …ä¸­ç²å–ç­ç´šè³‡è¨Š
            const selectedOption = classSelect.options[classSelect.selectedIndex];
            const teacherName = selectedOption.dataset.teacher;
            const studentCount = selectedOption.dataset.studentCount;
            
            if (!confirm(`ç¢ºå®šè¦å°‡å­¸ç”Ÿ ${studentId} è½‰ç­å—ï¼Ÿ\n\nç›®æ¨™ç­ç´šï¼š${selectedClass}\nå°æ‡‰è€å¸«ï¼š${teacherName}\nç›®å‰å­¸ç”Ÿæ•¸ï¼š${studentCount}äºº\n\næ­¤æ“ä½œæœƒå°‡å­¸ç”Ÿå¾åŸç­ç´šè½‰ç§»åˆ°æ–°ç­ç´šã€‚`)) {
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading('æ­£åœ¨è™•ç†å­¸ç”Ÿè½‰ç­...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showSuccess(`å­¸ç”Ÿè½‰ç­è™•ç†å®Œæˆï¼\n\nç•°å‹•IDï¼š${result.changeId}\n\nè©³ç´°è³‡è¨Šï¼š\n- å­¸ç”ŸIDï¼š${studentId}\n- ç›®æ¨™ç­ç´šï¼š${selectedClass}\n- æ–°è€å¸«ï¼š${teacherName}\n- è™•ç†æ™‚é–“ï¼š${new Date().toLocaleString()}`);
                        closeClassChangeModal();
                        updateStats();
                    } else {
                        showError('è½‰ç­è™•ç†å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('è½‰ç­è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processStudentClassChangeWeb({
                    studentId: studentId,
                    newClass: selectedClass,
                    newTeacher: teacherName
                });
        }
        
        function showInfoUpdateForm() {
            document.getElementById('infoUpdateModal').style.display = 'block';
        }
        
        function closeInfoUpdateModal() {
            document.getElementById('infoUpdateModal').style.display = 'none';
            document.getElementById('infoUpdateStudentId').value = '';
            document.getElementById('infoUpdateValue').value = '';
        }
        
        function processInfoUpdate() {
            const studentId = document.getElementById('infoUpdateStudentId').value.trim();
            const field = document.getElementById('infoUpdateField').value;
            const value = document.getElementById('infoUpdateValue').value.trim();
            
            if (!studentId) {
                showError('è«‹è¼¸å…¥å­¸ç”ŸID');
                return;
            }
            
            if (!value) {
                showError('è«‹è¼¸å…¥æ–°å€¼');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦æ›´æ–°å­¸ç”Ÿ ${studentId} çš„è³‡æ–™å—ï¼Ÿ\n\næ¬„ä½ï¼š${field}\næ–°å€¼ï¼š${value}\n\næ­¤æ“ä½œæœƒåŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸é—œè¨˜éŒ„ã€‚`)) {
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading('æ­£åœ¨æ›´æ–°å­¸ç”Ÿè³‡æ–™...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showSuccess(`å­¸ç”Ÿè³‡æ–™æ›´æ–°å®Œæˆï¼\n\nç•°å‹•IDï¼š${result.changeId}\n\nè©³ç´°è³‡è¨Šï¼š\n- å­¸ç”ŸIDï¼š${studentId}\n- æ›´æ–°æ¬„ä½ï¼š${field}\n- æ–°å€¼ï¼š${value}\n- è™•ç†æ™‚é–“ï¼š${new Date().toLocaleString()}`);
                        closeInfoUpdateModal();
                        updateStats();
                    } else {
                        showError('è³‡æ–™æ›´æ–°å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('è³‡æ–™æ›´æ–°å¤±æ•—ï¼š' + error.message);
                })
                .processStudentInfoUpdateWeb(studentId, field, value);
        }
        
        function viewChangeHistory() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                    } else {
                        alert('âŒ ç„¡æ³•é–‹å•Ÿç•°å‹•è¨˜éŒ„ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('âŒ é–‹å•Ÿç•°å‹•è¨˜éŒ„å¤±æ•—ï¼š' + error.message);
                })
                .getChangeHistoryUrlWeb();
        }
        
        function generateChangeReport() {
            const originalText = event.target.textContent;
            event.target.textContent = 'ç”Ÿæˆä¸­...';
            event.target.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    event.target.textContent = originalText;
                    event.target.disabled = false;
                    
                    if (result.success) {
                        if (confirm('âœ… ç•°å‹•çµ±è¨ˆå ±å‘Šç”Ÿæˆå®Œæˆï¼\n\næ˜¯å¦è¦é–‹å•Ÿå ±å‘Šï¼Ÿ')) {
                            window.open(result.reportUrl, '_blank');
                        }
                    } else {
                        alert('âŒ å ±å‘Šç”Ÿæˆå¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    event.target.textContent = originalText;
                    event.target.disabled = false;
                    alert('âŒ å ±å‘Šç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                })
                .generateChangeReportWeb();
        }
        
        function showRollbackForm() {
            document.getElementById('rollbackModal').style.display = 'block';
        }
        
        function closeRollbackModal() {
            document.getElementById('rollbackModal').style.display = 'none';
            document.getElementById('rollbackChangeId').value = '';
        }
        
        function processRollback() {
            const changeId = document.getElementById('rollbackChangeId').value.trim();
            
            if (!changeId) {
                alert('è«‹è¼¸å…¥ç•°å‹•ID');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å›æ»¾ç•°å‹• ${changeId} å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒå°‡æ‰€æœ‰ç›¸é—œè³‡æ–™æ¢å¾©åˆ°ç•°å‹•å‰ç‹€æ…‹ã€‚`)) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('âœ… ç•°å‹•å›æ»¾å®Œæˆï¼\n\næ‰€æœ‰è³‡æ–™å·²æ¢å¾©åˆ°ç•°å‹•å‰ç‹€æ…‹ã€‚');
                        closeRollbackModal();
                        updateStats();
                    } else {
                        alert('âŒ ç•°å‹•å›æ»¾å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('âŒ ç•°å‹•å›æ»¾å¤±æ•—ï¼š' + error.message);
                })
                .processStudentRollbackWeb(changeId);
        }
        
        // æ¨¡æ…‹æ¡†é—œé–‰äº‹ä»¶è™•ç† - ç§»å‹•åˆ° App.init() ä¸­

        function checkAllProgress() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'æª¢æŸ¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayProgressResults(result);
                    } else {
                        alert('æª¢æŸ¥å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('checkAllProgress');
        }
        
        function displayProgressResults(result) {
            if (!result.progressResults || result.progressResults.length === 0) {
                alert('âš ï¸ ' + result.message);
                return;
            }
            
            const summary = result.summary;
            let message = 'ğŸ“Š å…¨é«”è€å¸«é›»è¯é€²åº¦æª¢æŸ¥çµæœ\\n\\n';
            
            // ç¸½é«”çµ±è¨ˆ
            message += `ğŸ“ˆ ç¸½é«”çµ±è¨ˆï¼š\\n`;
            message += `â€¢ è€å¸«ç¸½æ•¸ï¼š${summary.totalTeachers} ä½\\n`;
            message += `â€¢ å­¸ç”Ÿç¸½æ•¸ï¼š${summary.totalStudents} ä½\\n`;
            message += `â€¢ ç´¯è¨ˆé›»è¯è¨˜éŒ„ï¼š${summary.totalContacts} ç­†\\n`;
            message += `â€¢ å­¸æœŸé›»è¯è¨˜éŒ„ï¼š${summary.totalSemesterContacts} ç­†\\n\\n`;
            
            // ç•¶å‰å­¸æœŸtermé€²åº¦
            message += `ğŸ¯ ${summary.currentSemester} ${summary.currentTerm} é€²åº¦ï¼š\\n`;
            message += `â€¢ å·²å®Œæˆï¼š${summary.currentTermCompleted}/${summary.currentTermTotal} ä½å­¸ç”Ÿ\\n`;
            message += `â€¢ å®Œæˆç‡ï¼š${summary.currentTermCompletionRate}%\\n\\n`;
            
            // ç‹€æ…‹åˆ†å¸ƒ
            message += `ğŸ“Š ç‹€æ…‹åˆ†å¸ƒï¼š\\n`;
            message += `â€¢ âœ… æ­£å¸¸ï¼š${summary.normalCount} ä½ (${summary.normalPercentage}%)\\n`;
            message += `â€¢ âš ï¸ å¾…æ”¹å–„ï¼š${summary.needImprovementCount} ä½ (${summary.needImprovementPercentage}%)\\n`;
            message += `â€¢ ğŸš¨ éœ€è¦é—œæ³¨ï¼š${summary.needAttentionCount} ä½ (${summary.needAttentionPercentage}%)\\n\\n`;
            
            // è©³ç´°åˆ—è¡¨
            if (summary.needAttentionCount > 0 || summary.needImprovementCount > 0) {
                message += `ğŸ“‹ éœ€è¦é—œæ³¨çš„è€å¸«ï¼š\\n`;
                result.progressResults.forEach(progress => {
                    if (progress.status !== 'æ­£å¸¸') {
                        message += `\\nâ€¢ ${progress.teacherName} (${progress.status})\\n`;
                        message += `  - å­¸ç”Ÿç¸½æ•¸ï¼š${progress.totalStudents} ä½\\n`;
                        message += `  - å­¸æœŸé›»è¯ï¼š${progress.semesterContacts || 0} ç­†\\n`;
                        if (progress.currentTermProgress) {
                            const remaining = progress.currentTermProgress.total - progress.currentTermProgress.completed;
                            message += `  - ç•¶å‰Termï¼š${progress.currentTermProgress.completed}/${progress.currentTermProgress.total} ä½å­¸ç”Ÿå·²å®Œæˆ\\n`;
                            if (remaining > 0) {
                                message += `  - å¾…é›»è¯ï¼š${remaining} ä½å­¸ç”Ÿ\\n`;
                            }
                        }
                        message += `  - æœ€å¾Œå­¸æœŸé›»è¯ï¼š${progress.lastContactDate}\\n`;
                        if (progress.alertMessage) {
                            message += `  - æé†’ï¼š${progress.alertMessage}\\n`;
                        }
                    }
                });
            } else {
                message += `ğŸ‰ æ‰€æœ‰è€å¸«çš„é›»è¯è¨˜éŒ„ç‹€æ…‹éƒ½å¾ˆè‰¯å¥½ï¼`;
            }
            
            // é¡¯ç¤ºéŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
            if (result.errors && result.errors.length > 0) {
                message += `\\n\\nâš ï¸ æª¢æŸ¥éç¨‹ä¸­çš„å•é¡Œï¼š\\n`;
                result.errors.forEach(error => {
                    message += `â€¢ ${error}\\n`;
                });
            }
            
            alert(message);
        }

        function generateProgressReport() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        let message = 'ğŸ“Š é€²åº¦å ±å‘Šç”Ÿæˆå®Œæˆï¼\\n\\n';
                        message += `â€¢ æª¢æŸ¥äº† ${result.teacherCount} ä½è€å¸«\\n`;
                        message += `â€¢ åŒ…å« ${result.dataCount} ç­†é›»è¯è¨˜éŒ„\\n\\n`;
                        message += 'é»æ“Šã€Œç¢ºå®šã€å¾Œå°‡é–‹å•Ÿå ±å‘Šæª”æ¡ˆã€‚';
                        
                        if (confirm(message)) {
                            window.open(result.reportUrl, '_blank');
                        }
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('generateProgressReport');
        }


        function setupAutomation() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¨­å®šä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ è¨­å®šå¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('è¨­å®šå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('setupAutomation');
        }

        function performBackup() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'å‚™ä»½ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ å‚™ä»½å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('å‚™ä»½å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('performBackup');
        }

        function checkFileIntegrity() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('æª”æ¡ˆå®Œæ•´æ€§æª¢æŸ¥å®Œæˆï¼');
                    } else {
                        alert('æª¢æŸ¥å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    alert('æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('checkFileIntegrity');
        }

        function showSystemSettings() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¼‰å…¥ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displaySystemSettings(result.settings);
                    } else {
                        alert('âŒ è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('âŒ è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—ï¼š' + error.message);
                })
                .executeSystemFunction('showSystemSettings');
        }

        function displaySystemSettings(settings) {
            let settingsHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px;">';
            
            settingsHTML += '<h2 style="color: #333; margin-bottom: 20px;">ğŸ“‹ ç³»çµ±è¨­å®šè³‡è¨Š</h2>';
            
            // ç³»çµ±ç‹€æ…‹
            if (settings.systemStatus) {
                settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px;">';
                settingsHTML += '<h3 style="color: #2c5282; margin-bottom: 10px;">ğŸ¥ ç³»çµ±ç‹€æ…‹</h3>';
                settingsHTML += `<p><strong>å¥åº·åº¦ï¼š</strong> ${settings.systemStatus.overallHealth}%</p>`;
                settingsHTML += `<p><strong>ç‹€æ…‹ï¼š</strong> ${settings.systemStatus.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</p>`;
                settingsHTML += `<p><strong>æè¿°ï¼š</strong> ${settings.systemStatus.statusDescription}</p>`;
                settingsHTML += '</div>';
            }
            
            // ç³»çµ±è³‡æ–™å¤¾è³‡è¨Š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f0fff4; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #2f855a; margin-bottom: 10px;">ğŸ“ è³‡æ–™å¤¾è¨­å®š</h3>';
            settingsHTML += `<p><strong>ä¸»è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.mainFolderName}</p>`;
            settingsHTML += `<p><strong>ä¸»è³‡æ–™å¤¾IDï¼š</strong> ${settings.systemInfo.mainFolderId}</p>`;
            settingsHTML += `<p><strong>è€å¸«è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.teachersFolderName}</p>`;
            settingsHTML += `<p><strong>ç¯„æœ¬è³‡æ–™å¤¾ï¼š</strong> ${settings.systemInfo.templatesFolderName}</p>`;
            if (settings.mainFolderUrl) {
                settingsHTML += `<p><a href="${settings.mainFolderUrl}" target="_blank" style="color: #3182ce; text-decoration: none;">ğŸ”— é–‹å•Ÿä¸»è³‡æ–™å¤¾</a></p>`;
            }
            settingsHTML += '</div>';
            
            // å­¸å¹´è¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fffbf0; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #c05621; margin-bottom: 10px;">ğŸ“… å­¸å¹´è¨­å®š</h3>';
            settingsHTML += `<p><strong>å­¸æœŸï¼š</strong> ${settings.academicYear.semesters.join(', ')}</p>`;
            settingsHTML += `<p><strong>æœŸåˆ¥ï¼š</strong> ${settings.academicYear.terms.join(', ')}</p>`;
            settingsHTML += `<p><strong>ç•¶å‰å­¸æœŸï¼š</strong> ${settings.academicYear.currentSemester}</p>`;
            settingsHTML += `<p><strong>ç•¶å‰æœŸåˆ¥ï¼š</strong> ${settings.academicYear.currentTerm}</p>`;
            settingsHTML += '</div>';
            
            // è¯ç¹«è¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #4a5568; margin-bottom: 10px;">ğŸ“ è¯ç¹«è¨­å®š</h3>';
            settingsHTML += `<p><strong>è¯ç¹«é¡å‹ï¼š</strong> ${Object.values(settings.contactSettings.contactTypes).join(', ')}</p>`;
            settingsHTML += `<p><strong>è¯ç¹«æ–¹å¼ï¼š</strong> ${settings.contactSettings.contactMethods.join(', ')}</p>`;
            settingsHTML += `<p><strong>æ¯æœŸå¿…é ˆè¯ç¹«æ¬¡æ•¸ï¼š</strong> ${settings.contactSettings.requiredContactPerTerm}</p>`;
            settingsHTML += `<p><strong>æé†’å¤©æ•¸ï¼š</strong> ${settings.contactSettings.alertDays}</p>`;
            settingsHTML += '</div>';
            
            // å¹´ç´šè¨­å®š
            settingsHTML += '<div style="margin-bottom: 20px; padding: 15px; background: #fef5e7; border-radius: 5px;">';
            settingsHTML += '<h3 style="color: #b7791f; margin-bottom: 10px;">ğŸ“ å¹´ç´šè¨­å®š</h3>';
            settingsHTML += `<p><strong>å¹´ç´šï¼š</strong> ${settings.gradeSettings.gradeLevels.join(', ')}</p>`;
            settingsHTML += `<p><strong>è‹±èªç­ç´šåç¨±ï¼š</strong> ${settings.gradeSettings.englishClassNames.slice(0, 5).join(', ')} ... (å…± ${settings.gradeSettings.englishClassNames.length} å€‹)</p>`;
            settingsHTML += '</div>';
            
            settingsHTML += '<div style="text-align: center; margin-top: 20px;">';
            settingsHTML += '<button onclick="closeSystemSettingsModal()" style="background: #4299e1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é—œé–‰</button>';
            settingsHTML += '</div>';
            
            settingsHTML += '</div>';
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            const modal = document.createElement('div');
            modal.id = 'systemSettingsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 10px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            modalContent.innerHTML = settingsHTML;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function closeSystemSettingsModal() {
            const modal = document.getElementById('systemSettingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ========== ç³»çµ±ç‹€æ…‹æª¢æŸ¥å’Œè¨­å®šç›¸é—œå‡½æ•¸ ==========

        
        function setupCompleteSystem() {
            if (confirm('ç¢ºå®šè¦åŸ·è¡Œä¸€éµå®Œæ•´è¨­å®šå—ï¼Ÿ\n\né€™å°‡åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š\nâ€¢ åˆå§‹åŒ–ç”Ÿç”¢ç’°å¢ƒï¼ˆè³‡æ–™å¤¾çµæ§‹ã€ç¯„æœ¬æª”æ¡ˆã€ç®¡ç†æ§åˆ¶å°ï¼‰\nâ€¢ åŸ·è¡Œç³»çµ±å¥åº·æª¢æŸ¥\n\næ•´å€‹éç¨‹éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'è¨­å®šä¸­...';
                button.disabled = true;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        button.textContent = originalText;
                        button.disabled = false;
                        
                        if (result.success) {
                            displayCompleteSetupResults(result);
                            // ç§»é™¤è‡ªå‹•æª¢æŸ¥ï¼Œè®“ç”¨æˆ¶æ‰‹å‹•æŸ¥çœ‹çµæœ
                        } else {
                            alert('ä¸€éµè¨­å®šå¤±æ•—ï¼š' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        button.textContent = originalText;
                        button.disabled = false;
                        alert('ä¸€éµè¨­å®šå¤±æ•—ï¼š' + error.message);
                    })
                    .setupCompleteSystemWeb();
            }
        }
        
        function updateSystemStatusDisplay(systemStatus) {
            const indicator = document.getElementById('systemStatusIndicator');
            const quickSetupSection = document.getElementById('quickSetupSection');
            
            let statusColor, statusIcon, statusText, statusMessage;
            
            // æ ¹æ“šå¥åº·åº¦å’Œåˆå§‹åŒ–ç‹€æ…‹è¨­å®šé¡è‰²å’Œè¨Šæ¯
            if (systemStatus.overallHealth === 0) {
                statusColor = '#f8d7da';
                statusIcon = 'âŒ';
                statusText = 'ç³»çµ±å°šæœªåˆå§‹åŒ–';
                statusMessage = 'æ²’æœ‰æ‰¾åˆ°ç³»çµ±è³‡æ–™å¤¾ - éœ€è¦åŸ·è¡Œå®Œæ•´åˆå§‹åŒ–';
            } else if (systemStatus.overallHealth < 50) {
                statusColor = '#fff3cd';
                statusIcon = 'âš ï¸';
                statusText = 'ç³»çµ±éƒ¨åˆ†åˆå§‹åŒ–';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'ç¼ºå°‘é—œéµçµ„ä»¶'}`;
            } else if (systemStatus.overallHealth < 95) {
                statusColor = '#cce7ff';
                statusIcon = 'ğŸ”§';
                statusText = 'ç³»çµ±åŸºæœ¬å°±ç·’';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'ä»éœ€å®Œå–„éƒ¨åˆ†çµ„ä»¶'}`;
            } else {
                statusColor = '#d4edda';
                statusIcon = 'âœ…';
                statusText = 'ç³»çµ±å®Œå…¨å°±ç·’';
                statusMessage = `å¥åº·åº¦ï¼š${systemStatus.overallHealth}% - ${systemStatus.statusDescription || 'å¯ä»¥æ­£å¸¸ä½¿ç”¨'}`;
            }
            
            // èª¿æ•´å¿«é€Ÿè¨­å®šå€åŸŸé¡¯ç¤ºé‚è¼¯
            if (systemStatus.overallHealth >= 95) {
                // ç³»çµ±å°±ç·’æ™‚é¡¯ç¤ºç¶­è­·é¸é …
                quickSetupSection.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 10px;">ğŸ› ï¸ ç³»çµ±ç¶­è­·</h3>
                        <p style="color: #155724; margin-bottom: 15px;">ç³»çµ±é‹ä½œæ­£å¸¸ã€‚å¦‚éœ€é‡æ–°è¨­å®šæˆ–ç¶­è­·ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹é¸é …ï¼š</p>
                        <button class="action-button secondary" onclick="setupCompleteSystem()" style="margin-right: 10px;">
                            ğŸ”„ å¼·åˆ¶é‡æ–°åˆå§‹åŒ–
                        </button>
                        <button class="action-button secondary" onclick="showDetailedDiagnostic()">
                            ğŸ” è©³ç´°è¨ºæ–·å ±å‘Š
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            } else {
                // ç³»çµ±æœªå°±ç·’æ™‚é¡¯ç¤ºè¨­å®šé¸é …
                quickSetupSection.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 10px;">âš¡ å¿«é€Ÿè¨­å®š</h3>
                        <p style="color: #856404; margin-bottom: 15px;">ç³»çµ±å°šæœªå®Œæ•´åˆå§‹åŒ–ï¼Œå»ºè­°å…ˆåŸ·è¡Œå®Œæ•´è¨­å®šï¼š</p>
                        <button class="action-button primary" onclick="setupCompleteSystem()">
                            ğŸš€ ä¸€éµå®Œæ•´è¨­å®š
                        </button>
                    </div>
                `;
                quickSetupSection.style.display = 'block';
            }
            
            // æ·»åŠ è©³ç´°çš„å»ºè­°ä¿¡æ¯
            let recommendations = '';
            if (systemStatus.recommendations && systemStatus.recommendations.length > 0) {
                recommendations = `<br><small style="opacity: 0.8;">å»ºè­°ï¼š${systemStatus.recommendations[0]}</small>`;
            }
            
            // æ·»åŠ é©—è­‰è©³æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
            let validationDetails = '';
            if (systemStatus.validationDetails && systemStatus.overallHealth < 95) {
                validationDetails = `<br><small style="opacity: 0.7; font-style: italic;">è©³æƒ…ï¼š${systemStatus.validationDetails}</small>`;
            }
            
            const borderColor = statusColor === '#d4edda' ? '#28a745' : 
                               statusColor === '#cce7ff' ? '#007bff' :
                               statusColor === '#fff3cd' ? '#ffc107' : '#dc3545';
            const textColor = statusColor === '#d4edda' ? '#155724' : 
                             statusColor === '#cce7ff' ? '#004085' :
                             statusColor === '#fff3cd' ? '#856404' : '#721c24';
            
            indicator.innerHTML = `
                <div style="background: ${statusColor}; padding: 15px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                    <h3 style="color: ${textColor}; margin-bottom: 10px;">${statusIcon} ${statusText}</h3>
                    <p style="color: ${textColor}; margin: 0;">${statusMessage}${recommendations}${validationDetails}</p>
                </div>
            `;
        }
        
        function displaySystemStatusDetails(systemStatus) {
            let statusDetails = `ğŸ” ç³»çµ±ç‹€æ…‹è©³ç´°å ±å‘Š\n\n`;
            statusDetails += `ğŸ“Š æ•´é«”å¥åº·åº¦ï¼š${systemStatus.overallHealth}%\n`;
            statusDetails += `âœ… ç³»çµ±åˆå§‹åŒ–ï¼š${systemStatus.initialized ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n\n`;
            
            statusDetails += `ğŸ­ ç”Ÿç”¢ç’°å¢ƒç‹€æ…‹ï¼š\n`;
            statusDetails += `â€¢ ä¸»è³‡æ–™å¤¾ï¼š${systemStatus.productionEnvironment.mainFolder ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            statusDetails += `â€¢ å­è³‡æ–™å¤¾ï¼š${systemStatus.productionEnvironment.subFolders ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´'}\n`;
            statusDetails += `â€¢ ç®¡ç†æ§åˆ¶å°ï¼š${systemStatus.productionEnvironment.adminConsole ? 'âœ… å·²å»ºç«‹' : 'âŒ æœªå»ºç«‹'}\n`;
            statusDetails += `â€¢ ç¯„æœ¬æª”æ¡ˆï¼š${systemStatus.productionEnvironment.templates ? 'âœ… å·²å»ºç«‹' : 'âŒ æœªå»ºç«‹'}\n\n`;
            
            statusDetails += `ğŸ’¡ å»ºè­°ï¼š\n`;
            systemStatus.recommendations.forEach(rec => {
                statusDetails += `â€¢ ${rec}\n`;
            });
            
            statusDetails += `\nğŸ“‹ ä¸‹ä¸€æ­¥ï¼š\n`;
            systemStatus.nextSteps.forEach(step => {
                statusDetails += `â€¢ ${step}\n`;
            });
            
            alert(statusDetails);
        }
        
        function displayCompleteSetupResults(result) {
            let message = 'ğŸš€ ä¸€éµå®Œæ•´è¨­å®šçµæœ\n\n';
            
            if (result.success) {
                message += 'âœ… è¨­å®šæˆåŠŸå®Œæˆï¼\n\n';
                message += 'ğŸ“‹ åŸ·è¡Œæ­¥é©Ÿï¼š\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
                
                message += '\nğŸ¯ ç³»çµ±ç¾åœ¨å·²æº–å‚™å°±ç·’ï¼Œæ‚¨å¯ä»¥ï¼š\n';
                message += 'â€¢ é–‹å§‹å»ºç«‹è€å¸«è¨˜éŒ„ç°¿\n';
                message += 'â€¢ åŒ¯å…¥å¯¦éš›å­¸ç”Ÿè³‡æ–™\n';
                message += 'â€¢ åŸ·è¡Œç³»çµ±æ¸¬è©¦é©—è­‰åŠŸèƒ½\n';
            } else {
                message += 'âŒ è¨­å®šéç¨‹ä¸­é‡åˆ°å•é¡Œ\n\n';
                message += 'éŒ¯èª¤è¨Šæ¯ï¼š\n';
                result.setupResults.errors.forEach(error => {
                    message += `â€¢ ${error}\n`;
                });
                
                message += '\nå·²å®Œæˆçš„æ­¥é©Ÿï¼š\n';
                result.setupResults.steps.forEach(step => {
                    message += `${step}\n`;
                });
            }
            
            alert(message);
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹ - ç§»å‹•åˆ° App.init() ä¸­

        // ========== è©³ç´°ç³»çµ±è¨ºæ–· ==========
        
        function showDetailedDiagnostic() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'è¨ºæ–·ä¸­...';
            button.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    if (result.success) {
                        displayDetailedDiagnostic(result.diagnostic);
                    } else {
                        alert('è©³ç´°è¨ºæ–·å¤±æ•—ï¼š' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    button.textContent = originalText;
                    button.disabled = false;
                    alert('è©³ç´°è¨ºæ–·å¤±æ•—ï¼š' + error.message);
                })
                .generateDetailedSystemDiagnosticWeb();
        }
        
        function displayDetailedDiagnostic(diagnostic) {
            let message = `ğŸ¥ è©³ç´°ç³»çµ±è¨ºæ–·å ±å‘Š\\n`;
            message += `ğŸ“… æª¢æŸ¥æ™‚é–“ï¼š${diagnostic.timestamp}\\n\\n`;
            
            // æª¢æŸ¥é …ç›®ç‹€æ…‹
            const checks = [
                { name: 'ğŸŒ Google Drive å­˜å–', item: diagnostic.driveAccess },
                { name: 'ğŸ“ è³‡æ–™å¤¾çµæ§‹', item: diagnostic.folderStructure },
                { name: 'âš™ï¸ ç³»çµ±é…ç½®', item: diagnostic.configurations },
                { name: 'ğŸ”‘ æ“ä½œæ¬Šé™', item: diagnostic.permissions }
            ];
            
            checks.forEach(check => {
                const statusIcon = check.item.status === 'success' ? 'âœ…' : 
                                 check.item.status === 'warning' ? 'âš ï¸' : 'âŒ';
                message += `${statusIcon} ${check.name}\\n`;
                message += `   ${check.item.details}\\n\\n`;
            });
            
            // å»ºè­°äº‹é …
            message += `ğŸ’¡ å»ºè­°äº‹é …ï¼š\\n`;
            diagnostic.recommendations.forEach(rec => {
                message += `â€¢ ${rec}\\n`;
            });
            
            alert(message);
        }

        // ========== ç³»çµ±æ¸¬è©¦ ==========
        
        function executeSystemTest() {
            if (confirm('ç¢ºå®šè¦åŸ·è¡Œç³»çµ±æ¸¬è©¦å—ï¼Ÿ\n\né€™å°‡æ¸¬è©¦ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\nâ€¢ æª¢æŸ¥å…¨é«”é€²åº¦\nâ€¢ ç”Ÿæˆé€²åº¦å ±å‘Š\nâ€¢ åŸ·è¡Œç³»çµ±å‚™ä»½\nâ€¢ æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§\n\næ¸¬è©¦éç¨‹ç´„éœ€2-3åˆ†é˜ã€‚')) {
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'æ¸¬è©¦ä¸­...';
                button.disabled = true;
                
                let testResults = [];
                let currentTest = 0;
                const testSteps = [
                    { name: 'æª¢æŸ¥å…¨é«”é€²åº¦', function: 'checkAllProgress' },
                    { name: 'ç”Ÿæˆé€²åº¦å ±å‘Š', function: 'generateProgressReport' },
                    { name: 'åŸ·è¡Œç³»çµ±å‚™ä»½', function: 'performBackup' },
                    { name: 'æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§', function: 'checkFileIntegrity' }
                ];
                
                function runNextTest() {
                    if (currentTest >= testSteps.length) {
                        // æ‰€æœ‰æ¸¬è©¦å®Œæˆ
                        button.textContent = originalText;
                        button.disabled = false;
                        displaySystemTestSummary(testResults);
                        return;
                    }
                    
                    const step = testSteps[currentTest];
                    button.textContent = `æ¸¬è©¦ä¸­... (${currentTest + 1}/${testSteps.length})`;
                    
                    google.script.run
                        .withSuccessHandler(function(result) {
                            testResults.push({
                                name: step.name,
                                success: result.success,
                                message: result.message || 'å®Œæˆ'
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .withFailureHandler(function(error) {
                            testResults.push({
                                name: step.name,
                                success: false,
                                message: error.message
                            });
                            currentTest++;
                            setTimeout(runNextTest, 500);
                        })
                        .executeSystemFunction(step.function);
                }
                
                runNextTest();
            }
        }
        
        function displaySystemTestSummary(results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            const successRate = Math.round((successCount / totalCount) * 100);
            
            let message = `ğŸ¯ ç³»çµ±æ¸¬è©¦çµæœæ‘˜è¦\\n\\n`;
            message += `ğŸ“Š ç¸½é«”è¡¨ç¾ï¼š${successCount}/${totalCount} é …æ¸¬è©¦é€šé (${successRate}%)\\n\\n`;
            
            message += `ğŸ“‹ è©³ç´°çµæœï¼š\\n`;
            results.forEach((result, index) => {
                const icon = result.success ? 'âœ…' : 'âŒ';
                message += `${icon} ${result.name}\\n`;
                if (!result.success) {
                    message += `   éŒ¯èª¤ï¼š${result.message}\\n`;
                }
            });
            
            if (successRate >= 75) {
                message += `\\nğŸ‰ æ¸¬è©¦è¡¨ç¾å„ªç§€ï¼ç³»çµ±é‹ä½œæ­£å¸¸ã€‚`;
            } else if (successRate >= 50) {
                message += `\\nâš ï¸ æ¸¬è©¦éƒ¨åˆ†é€šéï¼Œå»ºè­°æª¢æŸ¥å¤±æ•—é …ç›®ã€‚`;
            } else {
                message += `\\nğŸš¨ æ¸¬è©¦è¡¨ç¾ä¸ä½³ï¼Œç³»çµ±å¯èƒ½å­˜åœ¨å•é¡Œã€‚\\n`;
                message += `å»ºè­°ï¼šåŸ·è¡Œã€ŒğŸš€ ä¸€éµå®Œæ•´è¨­å®šã€é‡å»ºç³»çµ±ã€‚`;
            }
            
            alert(message);
        }
        

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const stats = result.stats;
                        document.getElementById('teacherCount').textContent = stats.teacherCount;
                        document.getElementById('studentCount').textContent = stats.studentCount;
                        document.getElementById('contactCount').textContent = stats.contactCount;
                        document.getElementById('semesterProgress').textContent = stats.currentTermProgress + '%';
                        document.getElementById('semesterProgressLabel').textContent = `${stats.currentSemester} ${stats.currentTerm}é€²åº¦`;
                    } else {
                        // ä½¿ç”¨é è¨­å€¼
                        document.getElementById('teacherCount').textContent = '0';
                        document.getElementById('studentCount').textContent = '0';
                        document.getElementById('contactCount').textContent = '0';
                        document.getElementById('semesterProgress').textContent = '0%';
                        document.getElementById('semesterProgressLabel').textContent = 'å­¸æœŸé€²åº¦';
                    }
                })
                .withFailureHandler(function(error) {
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä½¿ç”¨é è¨­å€¼
                    document.getElementById('teacherCount').textContent = '0';
                    document.getElementById('studentCount').textContent = '0';
                    document.getElementById('contactCount').textContent = '0';
                    document.getElementById('semesterProgress').textContent = '0%';
                    document.getElementById('semesterProgressLabel').textContent = 'å­¸æœŸé€²åº¦';
                })
                .getSystemStatsWeb();
        }

        // æ›´æ–°ç‰¹å®šå­¸æœŸéšæ®µçš„çµ±è¨ˆè³‡æ–™
        function updateStatsByStage(semester, term) {
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            document.getElementById('updateStatsBtn').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('updateStatsBtn').disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        updateStatsDisplay(result.stats);
                    } else {
                        alert('âŒ ç²å–çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š' + result.message);
                        updateStatsDisplay({
                            teacherCount: 0,
                            studentCount: 0,
                            contactCount: 0,
                            currentTermProgress: 0,
                            currentSemester: semester,
                            currentTerm: term
                        });
                    }
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('updateStatsBtn').textContent = 'æ›´æ–°çµ±è¨ˆ';
                    document.getElementById('updateStatsBtn').disabled = false;
                })
                .withFailureHandler(function(error) {
                    console.error('ç²å–ç‰¹å®šéšæ®µçµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š', error);
                    alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('updateStatsBtn').textContent = 'æ›´æ–°çµ±è¨ˆ';
                    document.getElementById('updateStatsBtn').disabled = false;
                })
                .getProgressByStageWeb(semester, term);
        }
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“šé¡¯ç¤º
        function updateStatsDisplay(stats) {
            document.getElementById('teacherCount').textContent = stats.teacherCount;
            document.getElementById('studentCount').textContent = stats.studentCount;
            document.getElementById('contactCount').textContent = stats.contactCount;
            document.getElementById('semesterProgress').textContent = stats.currentTermProgress + '%';
            document.getElementById('semesterProgressLabel').textContent = `${stats.currentSemester} ${stats.currentTerm}é€²åº¦`;
        }

        // ç­ç´šç®¡ç†ç›¸é—œå‡½æ•¸
        function loadAvailableClasses() {
            const classSelect = document.getElementById('classChangeNewClass');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            classSelect.innerHTML = '<option value="">è¼‰å…¥ç­ç´šä¸­...</option>';
            classSelect.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    classSelect.disabled = false;
                    if (result.success && result.classes.length > 0) {
                        populateClassDropdown(result.classes);
                    } else {
                        classSelect.innerHTML = '<option value="">ç„¡å¯ç”¨ç­ç´š</option>';
                        showError('è¼‰å…¥ç­ç´šå¤±æ•—ï¼š' + (result.message || 'æ‰¾ä¸åˆ°å¯ç”¨ç­ç´š'));
                    }
                })
                .withFailureHandler(function(error) {
                    classSelect.disabled = false;
                    classSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    showError('è¼‰å…¥ç­ç´šå¤±æ•—ï¼š' + error.message);
                })
                .getAvailableClassesWeb();
        }
        
        function populateClassDropdown(classes) {
            const classSelect = document.getElementById('classChangeNewClass');
            let options = '<option value="">è«‹é¸æ“‡ç­ç´š...</option>';
            
            classes.forEach(classInfo => {
                options += `<option value="${classInfo.value}" 
                           data-teacher="${classInfo.teacher}" 
                           data-student-count="${classInfo.studentCount}">
                           ${classInfo.display}
                           </option>`;
            });
            
            classSelect.innerHTML = options;
        }
        
        function onClassSelected() {
            const classSelect = document.getElementById('classChangeNewClass');
            const classInfoDiv = document.getElementById('selectedClassInfo');
            
            if (classSelect.value) {
                const selectedOption = classSelect.options[classSelect.selectedIndex];
                const teacher = selectedOption.dataset.teacher;
                const studentCount = selectedOption.dataset.studentCount;
                const className = selectedOption.value;
                
                classInfoDiv.innerHTML = `
                    <div class="class-info-item">
                        <span><strong>ç­ç´šï¼š</strong></span>
                        <span>${className}</span>
                    </div>
                    <div class="class-info-item">
                        <span><strong>å°æ‡‰è€å¸«ï¼š</strong></span>
                        <span>${teacher}</span>
                    </div>
                    <div class="class-info-item">
                        <span><strong>ç›®å‰å­¸ç”Ÿæ•¸ï¼š</strong></span>
                        <span>${studentCount}äºº</span>
                    </div>
                `;
                classInfoDiv.classList.add('show');
            } else {
                classInfoDiv.classList.remove('show');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æ›´æ–°çµ±è¨ˆ - ç§»å‹•åˆ° App.init() ä¸­
        
        // ===== APPLICATION STARTUP =====
        // çµ±ä¸€çš„æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç§»é™¤å¤šå€‹DOMContentLoadedäº‹ä»¶ç›£è½å™¨çš„è¡çª
            // çµ±ä¸€åœ¨App.init()ä¸­è™•ç†æ‰€æœ‰åˆå§‹åŒ–é‚è¼¯
            App.init().catch(error => {
                console.error('Application startup failed:', error);
            });
        });
        
        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚é‡æ–°è¼‰å…¥çµ±è¨ˆ (Performance optimization)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && StateManager.getState('systemStats')) {
                App.updateSystemStats();
            }
        });
        
        // çª—å£å¤§å°è®ŠåŒ–æ™‚å„ªåŒ–å¸ƒå±€ (Responsive handling)
        window.addEventListener('resize', function() {
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ éŸ¿æ‡‰å¼å¸ƒå±€èª¿æ•´é‚è¼¯
        });
    </script>
    
    <!-- è¼‰å…¥å‹•ç•«è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">è™•ç†ä¸­...</div>
        </div>
    </div>
    
    <!-- æˆåŠŸæç¤ºå½ˆçª— -->
    <div id="successPopup" class="success-popup">
        <h3>âœ… æ“ä½œæˆåŠŸ</h3>
        <p id="successMessage">æ“ä½œå·²æˆåŠŸå®Œæˆï¼</p>
        <button class="btn-success" onclick="closeSuccessPopup()">ç¢ºå®š</button>
    </div>
    
    <!-- éŒ¯èª¤æç¤ºå½ˆçª— -->
    <div id="errorPopup" class="error-popup">
        <h3>âŒ æ“ä½œå¤±æ•—</h3>
        <p id="errorMessage">æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚</p>
        <button class="btn-danger" onclick="closeErrorPopup()">ç¢ºå®š</button>
    </div>
    
</body>
</html>